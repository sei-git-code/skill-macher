# 設定設計書

## 1. 設定設計概要

### 1.1 設計方針

- **環境分離**: dev, staging, prod 環境の設定分離
- **セキュリティ**: 機密情報の適切な管理
- **保守性**: 設定の一元管理とバージョン管理
- **柔軟性**: 環境変数による動的設定

### 1.2 設定ファイル構成

```
src/main/resources/
├── application.yml                 # 共通設定
├── application-dev.yml            # 開発環境設定
├── application-staging.yml        # ステージング環境設定
├── application-prod.yml           # 本番環境設定
└── logback-spring.xml             # ログ設定
```

## 2. アプリケーション設定

### 2.1 共通設定 (application.yml)

```yaml
spring:
  application:
    name: ses-sales-support-tool
    version: 1.0.0

  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  main:
    banner-mode: console
    web-application-type: servlet

  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB

  jackson:
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false

server:
  port: ${PORT:8080}
  servlet:
    context-path: /
    session:
      timeout: 30m
      cookie:
        http-only: true
        secure: true
        same-site: strict
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024
  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: on_param
    include-exception: false

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,env,beans
      base-path: /actuator
  endpoint:
    health:
      show-details: when_authorized
      show-components: always
    info:
      env:
        enabled: true
  info:
    env:
      enabled: true
    java:
      enabled: true
    build:
      enabled: true

logging:
  level:
    root: INFO
    com.ses.sales.support: DEBUG
    org.springframework.security: DEBUG
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${LOG_FILE_PATH:/var/log/ses-sales-support/application.log}
    max-size: 100MB
    max-history: 30
    total-size-cap: 1GB
```

### 2.2 開発環境設定 (application-dev.yml)

```yaml
spring:
  datasource:
    url: ${DATABASE_URL:jdbc:postgresql://localhost:5432/ses_sales_support_dev}?sslmode=require
    username: ${DATABASE_USERNAME:postgres}
    password: ${DATABASE_PASSWORD:dev_password}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 30000
      leak-detection-threshold: 60000
      ssl: true
      ssl-mode: require

# Supabase JWT設定
supabase:
  jwt:
    secret: ${SUPABASE_JWT_SECRET:your-jwt-secret}
    issuer: ${SUPABASE_URL:https://your-project.supabase.co}
    audience: authenticated
  url: ${SUPABASE_URL:https://your-project.supabase.co}
  anon-key: ${SUPABASE_ANON_KEY:your-anon-key}

  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        show_sql: true
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true
    show-sql: true
    open-in-view: false

  thymeleaf:
    cache: false
    prefix: classpath:/templates/
    suffix: .html
    encoding: UTF-8
    mode: HTML
    servlet:
      content-type: text/html

  security:
    jwt:
      secret: ${JWT_SECRET:dev-secret-key-for-development-only}
      expiration: 86400000 # 24時間
      refresh-expiration: 604800000 # 7日間

server:
  port: 8080
  servlet:
    session:
      cookie:
        secure: false # 開発環境ではfalse

logging:
  level:
    com.ses.sales.support: DEBUG
    org.springframework.security: DEBUG
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  file:
    name: logs/application-dev.log

# 開発環境専用設定
dev:
  cors:
    allowed-origins: http://localhost:3000,http://localhost:8080
    allowed-methods: GET,POST,PUT,DELETE,OPTIONS
    allowed-headers: "*"
    allow-credentials: true

  mock-data:
    enabled: true
    user-count: 10
    job-requirement-count: 20
    employee-count: 50
```

### 2.3 ステージング環境設定 (application-staging.yml)

```yaml
spring:
  datasource:
    url: ${SUPABASE_DATABASE_URL}
    username: ${SUPABASE_DATABASE_USERNAME}
    password: ${SUPABASE_DATABASE_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 30000
      leak-detection-threshold: 60000

  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: false
        show_sql: false
        jdbc:
          batch_size: 25
        order_inserts: true
        order_updates: true
    show-sql: false
    open-in-view: false

  thymeleaf:
    cache: true
    prefix: classpath:/templates/
    suffix: .html
    encoding: UTF-8
    mode: HTML

  security:
    jwt:
      secret: ${JWT_SECRET}
      expiration: 43200000 # 12時間
      refresh-expiration: 604800000 # 7日間

server:
  port: ${PORT:8080}
  servlet:
    session:
      cookie:
        secure: true

logging:
  level:
    com.ses.sales.support: INFO
    org.springframework.security: WARN
    org.springframework.web: WARN
    org.hibernate.SQL: WARN
  file:
    name: /var/log/ses-sales-support/application-staging.log
    max-size: 200MB
    max-history: 14
    total-size-cap: 2GB

# ステージング環境専用設定
staging:
  cors:
    allowed-origins: https://staging.ses-sales-support.example.com
    allowed-methods: GET,POST,PUT,DELETE,OPTIONS
    allowed-headers: "*"
    allow-credentials: true

  monitoring:
    enabled: true
    metrics:
      enabled: true
    tracing:
      enabled: true
```

### 2.4 本番環境設定 (application-prod.yml)

```yaml
spring:
  datasource:
    url: ${SUPABASE_DATABASE_URL}
    username: ${SUPABASE_DATABASE_USERNAME}
    password: ${SUPABASE_DATABASE_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 30
      minimum-idle: 10
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 30000
      leak-detection-threshold: 60000
      pool-name: SES-Sales-Support-Pool

  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: false
        show_sql: false
        jdbc:
          batch_size: 30
        order_inserts: true
        order_updates: true
        connection:
          provider_disables_autocommit: true
    show-sql: false
    open-in-view: false

  thymeleaf:
    cache: true
    prefix: classpath:/templates/
    suffix: .html
    encoding: UTF-8
    mode: HTML

  security:
    jwt:
      secret: ${JWT_SECRET}
      expiration: 1800000 # 30分
      refresh-expiration: 604800000 # 7日間

  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=1000,expireAfterWrite=1h

server:
  port: ${PORT:8080}
  servlet:
    session:
      cookie:
        secure: true
        same-site: strict
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024

logging:
  level:
    com.ses.sales.support: INFO
    org.springframework.security: WARN
    org.springframework.web: WARN
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql.BasicBinder: WARN
  file:
    name: /var/log/ses-sales-support/application-prod.log
    max-size: 500MB
    max-history: 30
    total-size-cap: 10GB
  logback:
    rollingpolicy:
      max-file-size: 100MB
      max-history: 30
      total-size-cap: 5GB

# 本番環境専用設定
production:
  cors:
    allowed-origins: https://ses-sales-support.example.com
    allowed-methods: GET,POST,PUT,DELETE,OPTIONS
    allowed-headers: "*"
    allow-credentials: true

  monitoring:
    enabled: true
    metrics:
      enabled: true
      export:
        prometheus:
          enabled: true
    tracing:
      enabled: true

  security:
    rate-limiting:
      enabled: true
      requests-per-minute: 100
      burst-capacity: 200

  performance:
    connection-pool:
      max-size: 30
      min-size: 10
    cache:
      enabled: true
      ttl: 3600 # 1時間
```

## 3. Spring Security 設定

### 3.1 SecurityConfig 設定

```java
package com.ses.sales.support.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;
import java.util.List;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Value("${spring.profiles.active}")
    private String activeProfile;

    @Value("${dev.cors.allowed-origins:}")
    private String devAllowedOrigins;

    @Value("${staging.cors.allowed-origins:}")
    private String stagingAllowedOrigins;

    @Value("${production.cors.allowed-origins:}")
    private String productionAllowedOrigins;

    private final JwtAuthenticationFilter jwtAuthenticationFilter;

    public SecurityConfig(JwtAuthenticationFilter jwtAuthenticationFilter) {
        this.jwtAuthenticationFilter = jwtAuthenticationFilter;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/login", "/register", "/css/**", "/js/**", "/images/**", "/favicon.ico").permitAll()
                .requestMatchers("/actuator/health", "/actuator/info").permitAll()
                .requestMatchers("/api/v1/admin/**").hasRole("ADMIN")
                .requestMatchers("/api/v1/manager/**").hasAnyRole("ADMIN", "MANAGER")
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();

        // 環境別のCORS設定
        switch (activeProfile) {
            case "dev":
                configuration.setAllowedOrigins(Arrays.asList(devAllowedOrigins.split(",")));
                configuration.setAllowCredentials(true);
                break;
            case "staging":
                configuration.setAllowedOrigins(Arrays.asList(stagingAllowedOrigins.split(",")));
                configuration.setAllowCredentials(true);
                break;
            case "prod":
                configuration.setAllowedOrigins(Arrays.asList(productionAllowedOrigins.split(",")));
                configuration.setAllowCredentials(true);
                break;
        }

        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        configuration.setAllowedHeaders(Arrays.asList("*"));
        configuration.setMaxAge(3600L);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(12);
    }
}
```

### 3.2 JWT 設定

```java
package com.ses.sales.support.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@Component
@ConfigurationProperties(prefix = "spring.security.jwt")
public class JwtProperties {

    private String secret;
    private long expiration;
    private long refreshExpiration;

    // Getters and Setters
    public String getSecret() {
        return secret;
    }

    public void setSecret(String secret) {
        this.secret = secret;
    }

    public long getExpiration() {
        return expiration;
    }

    public void setExpiration(long expiration) {
        this.expiration = expiration;
    }

    public long getRefreshExpiration() {
        return refreshExpiration;
    }

    public void setRefreshExpiration(long refreshExpiration) {
        this.refreshExpiration = refreshExpiration;
    }
}
```

## 4. データベース設定

### 4.1 DatabaseConfig 設定

```java
package com.ses.sales.support.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;

import javax.sql.DataSource;
import java.util.Properties;

@Configuration
@EnableJpaRepositories(basePackages = "com.ses.sales.support.repository")
public class DatabaseConfig {

    @Value("${spring.jpa.hibernate.ddl-auto}")
    private String ddlAuto;

    @Value("${spring.jpa.show-sql}")
    private boolean showSql;

    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(DataSource dataSource) {
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setDataSource(dataSource);
        em.setPackagesToScan("com.ses.sales.support.entity");

        HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();
        em.setJpaVendorAdapter(vendorAdapter);

        Properties properties = new Properties();
        properties.setProperty("hibernate.hbm2ddl.auto", ddlAuto);
        properties.setProperty("hibernate.dialect", "org.hibernate.dialect.PostgreSQLDialect");
        properties.setProperty("hibernate.format_sql", String.valueOf(showSql));
        properties.setProperty("hibernate.show_sql", String.valueOf(showSql));
        properties.setProperty("hibernate.jdbc.batch_size", "20");
        properties.setProperty("hibernate.order_inserts", "true");
        properties.setProperty("hibernate.order_updates", "true");
        properties.setProperty("hibernate.connection.provider_disables_autocommit", "true");

        em.setJpaProperties(properties);

        return em;
    }

    @Bean
    public JpaTransactionManager transactionManager(LocalContainerEntityManagerFactoryBean entityManagerFactory) {
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(entityManagerFactory.getObject());
        return transactionManager;
    }
}
```

### 4.2 Supabase 接続設定

```yaml
# Supabase 接続設定
supabase:
  url: ${SUPABASE_URL}
  anon-key: ${SUPABASE_ANON_KEY}
  service-role-key: ${SUPABASE_SERVICE_ROLE_KEY}

  database:
    host: ${SUPABASE_DATABASE_HOST}
    port: ${SUPABASE_DATABASE_PORT:5432}
    name: ${SUPABASE_DATABASE_NAME:postgres}
    username: ${SUPABASE_DATABASE_USERNAME}
    password: ${SUPABASE_DATABASE_PASSWORD}
    ssl-mode: require

  auth:
    enabled: true
    providers:
      - email
      - google
      - github

  storage:
    enabled: true
    buckets:
      - user-uploads
      - documents
      - backups
```

## 5. ログ設定

### 5.1 Logback 設定 (logback-spring.xml)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <!-- 環境別設定 -->
    <springProfile name="dev">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
                <charset>UTF-8</charset>
            </encoder>
        </appender>

        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>logs/application-dev.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>logs/application-dev.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
                <totalSizeCap>1GB</totalSizeCap>
            </rollingPolicy>
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
                <charset>UTF-8</charset>
            </encoder>
        </appender>

        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>

    <springProfile name="staging">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>/var/log/ses-sales-support/application-staging.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>/var/log/ses-sales-support/application-staging.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>200MB</maxFileSize>
                <maxHistory>14</maxHistory>
                <totalSizeCap>2GB</totalSizeCap>
            </rollingPolicy>
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
                <charset>UTF-8</charset>
            </encoder>
        </appender>

        <root level="INFO">
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>

    <springProfile name="prod">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>/var/log/ses-sales-support/application-prod.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>/var/log/ses-sales-support/application-prod.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>500MB</maxFileSize>
                <maxHistory>30</maxHistory>
                <totalSizeCap>10GB</totalSizeCap>
            </rollingPolicy>
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
                <charset>UTF-8</charset>
            </encoder>
        </appender>

        <!-- エラーログ専用アペンダー -->
        <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>/var/log/ses-sales-support/error.log</file>
            <filter class="ch.qos.logback.classic.filter.LevelFilter">
                <level>ERROR</level>
                <onMatch>ACCEPT</onMatch>
                <onMismatch>DENY</onMismatch>
            </filter>
            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>/var/log/ses-sales-support/error.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>90</maxHistory>
                <totalSizeCap>5GB</totalSizeCap>
            </rollingPolicy>
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
                <charset>UTF-8</charset>
            </encoder>
        </appender>

        <root level="INFO">
            <appender-ref ref="FILE"/>
            <appender-ref ref="ERROR_FILE"/>
        </root>
    </springProfile>

    <!-- アプリケーション固有のログ設定 -->
    <logger name="com.ses.sales.support" level="DEBUG" additivity="false">
        <appender-ref ref="FILE"/>
    </logger>

    <logger name="org.springframework.security" level="DEBUG" additivity="false">
        <appender-ref ref="FILE"/>
    </logger>

    <logger name="org.hibernate.SQL" level="DEBUG" additivity="false">
        <appender-ref ref="FILE"/>
    </logger>

    <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE" additivity="false">
        <appender-ref ref="FILE"/>
    </logger>
</configuration>
```

## 6. キャッシュ設定

### 6.1 CacheConfig 設定

```java
package com.ses.sales.support.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cache.CacheManager;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.cache.caffeine.CaffeineCacheManager;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import com.github.benmanes.caffeine.cache.Caffeine;

import java.util.concurrent.TimeUnit;

@Configuration
@EnableCaching
public class CacheConfig {

    @Value("${spring.cache.caffeine.spec:maximumSize=1000,expireAfterWrite=1h}")
    private String cacheSpec;

    @Bean
    public CacheManager cacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        cacheManager.setCaffeine(Caffeine.from(cacheSpec));
        cacheManager.setCacheNames("skillMappings", "skillCategories", "users", "jobRequirements");
        return cacheManager;
    }
}
```

## 7. 監視設定

### 7.1 Actuator 設定

```yaml
# 監視設定
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,env,beans,loggers
      base-path: /actuator
  endpoint:
    health:
      show-details: when_authorized
      show-components: always
      probes:
        enabled: true
    info:
      env:
        enabled: true
      java:
        enabled: true
      build:
        enabled: true
      git:
        enabled: true
  info:
    env:
      enabled: true
    java:
      enabled: true
    build:
      enabled: true
    git:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.9,0.95,0.99
```

### 7.2 カスタムヘルスチェック

```java
package com.ses.sales.support.config;

import org.springframework.boot.actuator.health.Health;
import org.springframework.boot.actuator.health.HealthIndicator;
import org.springframework.stereotype.Component;

import javax.sql.DataSource;
import java.sql.Connection;

@Component
public class DatabaseHealthIndicator implements HealthIndicator {

    private final DataSource dataSource;

    public DatabaseHealthIndicator(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    @Override
    public Health health() {
        try (Connection connection = dataSource.getConnection()) {
            if (connection.isValid(1)) {
                return Health.up()
                    .withDetail("database", "Supabase PostgreSQL")
                    .withDetail("status", "Connected")
                    .withDetail("url", connection.getMetaData().getURL())
                    .build();
            }
        } catch (Exception e) {
            return Health.down()
                .withDetail("database", "Supabase PostgreSQL")
                .withDetail("error", e.getMessage())
                .build();
        }
        return Health.down().build();
    }
}
```

## 8. 環境変数設定

### 8.1 環境変数一覧

```bash
# アプリケーション設定
SPRING_PROFILES_ACTIVE=prod
PORT=8080

# データベース設定
SUPABASE_DATABASE_URL=jdbc:postgresql://db.xxxxxxxxxxxx.supabase.co:5432/postgres
SUPABASE_DATABASE_USERNAME=postgres
SUPABASE_DATABASE_PASSWORD=your-secure-password

# JWT設定
JWT_SECRET=your-super-secret-jwt-key-at-least-256-bits-long

# Supabase設定
SUPABASE_URL=https://xxxxxxxxxxxx.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# ログ設定
LOG_FILE_PATH=/var/log/ses-sales-support/application.log

# 監視設定
MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics,prometheus
```

### 8.2 Docker 環境変数

```dockerfile
# Dockerfile
ENV SPRING_PROFILES_ACTIVE=prod
ENV PORT=8080
ENV LOG_FILE_PATH=/var/log/ses-sales-support/application.log
```

### 8.3 Kubernetes 環境変数

```yaml
# kubernetes-deployment.yaml
env:
  - name: SPRING_PROFILES_ACTIVE
    value: "prod"
  - name: PORT
    value: "8080"
  - name: SUPABASE_DATABASE_URL
    valueFrom:
      secretKeyRef:
        name: database-secret
        key: url
  - name: SUPABASE_DATABASE_USERNAME
    valueFrom:
      secretKeyRef:
        name: database-secret
        key: username
  - name: SUPABASE_DATABASE_PASSWORD
    valueFrom:
      secretKeyRef:
        name: database-secret
        key: password
  - name: JWT_SECRET
    valueFrom:
      secretKeyRef:
        name: jwt-secret
        key: secret
```

## 9. 設定の管理

### 9.1 設定のバージョン管理

```bash
# 設定ファイルのバージョン管理
git add src/main/resources/application*.yml
git commit -m "Update application configuration"
git tag -a v1.0.0-config -m "Configuration for version 1.0.0"
```

### 9.2 設定の検証

```java
package com.ses.sales.support.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;
import org.springframework.validation.annotation.Validated;

import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;

@Component
@ConfigurationProperties(prefix = "app")
@Validated
public class AppProperties {

    @NotBlank
    private String name;

    @NotNull
    private Integer version;

    // Getters and Setters
    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Integer getVersion() {
        return version;
    }

    public void setVersion(Integer version) {
        this.version = version;
    }
}
```

### 9.3 設定の動的更新

```java
package com.ses.sales.support.config;

import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.stereotype.Component;

@Component
@RefreshScope
public class DynamicConfig {

    @Value("${app.dynamic.setting:default-value}")
    private String dynamicSetting;

    public String getDynamicSetting() {
        return dynamicSetting;
    }
}
```

## 10. セキュリティ設定

### 10.1 機密情報の管理

```yaml
# 機密情報の管理
secrets:
  database:
    url: ${SUPABASE_DATABASE_URL}
    username: ${SUPABASE_DATABASE_USERNAME}
    password: ${SUPABASE_DATABASE_PASSWORD}

  jwt:
    secret: ${JWT_SECRET}

  supabase:
    url: ${SUPABASE_URL}
    anon-key: ${SUPABASE_ANON_KEY}
    service-role-key: ${SUPABASE_SERVICE_ROLE_KEY}
```

### 10.2 設定の暗号化

```java
package com.ses.sales.support.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.encrypt.Encryptors;
import org.springframework.security.crypto.encrypt.TextEncryptor;

@Configuration
public class EncryptionConfig {

    @Bean
    public TextEncryptor textEncryptor(@Value("${app.encryption.password}") String password) {
        return Encryptors.text(password, "deadbeef");
    }
}
```

## 11. パフォーマンス設定

### 11.1 接続プール設定

```yaml
# 接続プール設定
spring:
  datasource:
    hikari:
      maximum-pool-size: ${DB_POOL_MAX_SIZE:30}
      minimum-idle: ${DB_POOL_MIN_IDLE:10}
      idle-timeout: ${DB_POOL_IDLE_TIMEOUT:300000}
      max-lifetime: ${DB_POOL_MAX_LIFETIME:1200000}
      connection-timeout: ${DB_POOL_CONNECTION_TIMEOUT:30000}
      leak-detection-threshold: ${DB_POOL_LEAK_DETECTION:60000}
      pool-name: SES-Sales-Support-Pool
```

### 11.2 JPA 設定

```yaml
# JPA設定
spring:
  jpa:
    properties:
      hibernate:
        jdbc:
          batch_size: ${JPA_BATCH_SIZE:30}
        order_inserts: true
        order_updates: true
        connection:
          provider_disables_autocommit: true
        cache:
          use_second_level_cache: true
          use_query_cache: true
          region:
            factory_class: org.hibernate.cache.jcache.JCacheRegionFactory
```

## 12. 設定のテスト

### 12.1 設定のテスト

```java
package com.ses.sales.support.config;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;

@SpringBootTest
@ActiveProfiles("test")
class ConfigurationTest {

    @Test
    void testConfiguration() {
        // 設定のテスト
    }
}
```

### 12.2 環境別設定のテスト

```java
package com.ses.sales.support.config;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.TestPropertySource;

@SpringBootTest
@TestPropertySource(properties = {
    "spring.datasource.url=jdbc:h2:mem:testdb",
    "spring.jpa.hibernate.ddl-auto=create-drop"
})
class EnvironmentConfigurationTest {

    @Test
    void testEnvironmentConfiguration() {
        // 環境別設定のテスト
    }
}
```
