# スキルマッチングロジック設計書

## 1. 概要

### 1.1 目的

SES 営業支援ツールにおけるスキルマッチング機能の詳細なロジック設計

### 1.2 スコープ

- スキル評価アルゴリズム
- マッチング計算ロジック
- スコア算出方法
- 推奨度判定ロジック

## 2. スキルマッチングアルゴリズム

### 2.1 全体フロー (Spring Boot)

```
1. Thymeleafフォームから要項入力
2. Controllerでリクエスト受信
3. Service層でビジネスロジック実行
4. Repository層でSupabase PostgreSQLからデータ取得
5. スキル評価ロジック実行
6. マッチ度計算
7. Thymeleafテンプレートで結果表示
8. 詳細分析生成
```

### 2.2 マッチング計算の詳細フロー (Spring Boot)

```
入力: 要項ID, 人員IDリスト
↓
Controller: @PostMapping("/matching/execute")
↓
Service: SkillMatchingService.executeMatching()
↓
Repository: Supabase PostgreSQLからデータ取得
  ├─ JobRequirementRepository.findById()
  ├─ EmployeeRepository.findByIdIn()
  └─ SkillMappingRepository.findAll()
↓
FOR EACH 人員:
  ├─ スキルマッチスコア計算
  ├─ 経験年数マッチスコア計算
  ├─ 習熟度マッチスコア計算
  ├─ 総合スコア計算
  ├─ 推奨度判定
  └─ MatchingResultRepository.save()
↓
結果をスコア順でソート
↓
Thymeleafテンプレートで結果表示
```

## 3. スコア算出ロジック

### 3.1 スキルマッチスコア (Skill Match Score)

#### 3.1.1 計算式

```
スキルマッチスコア = (必須スキルマッチ + 希望スキルマッチ) / 総スキル数 × 100

必須スキルマッチ = Σ(必須スキルのマッチ度)
希望スキルマッチ = Σ(希望スキルのマッチ度 × 0.5)
総スキル数 = 必須スキル数 + 希望スキル数 × 0.5
```

#### 3.1.2 スキルマッチ度の計算 (Java)

```java
@Service
public class SkillMatchingService {

    public double calculateSkillMatch(String requiredSkill, List<EmployeeSkill> employeeSkills) {
        // 1. 完全一致チェック
        Optional<EmployeeSkill> exactMatch = employeeSkills.stream()
            .filter(skill -> skill.getTechnology().equalsIgnoreCase(requiredSkill))
            .findFirst();

        if (exactMatch.isPresent()) {
            return calculateExactMatchScore(exactMatch.get());
        }

        // 2. 関連スキルチェック
        List<EmployeeSkill> relatedSkills = findRelatedSkills(requiredSkill, employeeSkills);
        if (!relatedSkills.isEmpty()) {
            return calculateRelatedMatchScore(relatedSkills.get(0), requiredSkill);
        }

        // 3. マッチなし
        return 0.0;
    }

    private double calculateExactMatchScore(EmployeeSkill skill) {
        Map<String, Double> proficiencyWeight = Map.of(
            "expert", 1.0,
            "advanced", 0.9,
            "intermediate", 0.7,
            "beginner", 0.4
        );

        double experienceWeight = Math.min(skill.getExperienceYears() / 5.0, 1.0);
        double proficiencyScore = proficiencyWeight.getOrDefault(skill.getProficiency(), 0.0);

        return proficiencyScore * experienceWeight * 100;
    }

    private double calculateRelatedMatchScore(EmployeeSkill relatedSkill, String requiredSkill) {
        SkillMapping mapping = skillMappingRepository.findByFromTechnologyAndToTechnology(
            relatedSkill.getTechnology(), requiredSkill);

        if (mapping == null) {
            return 0.0;
        }

        double baseScore = calculateExactMatchScore(relatedSkill);
        return baseScore * (mapping.getCompatibilityScore() / 100.0);
    }
}
```

### 3.2 経験年数マッチスコア (Experience Match Score)

#### 3.2.1 計算式 (Java)

```java
public double calculateExperienceMatchScore(int requiredYears, double employeeYears) {
    if (employeeYears >= requiredYears) {
        // 要求年数を満たしている場合
        double excessYears = employeeYears - requiredYears;
        double bonusScore = Math.min(excessYears * 5, 20); // 最大20点のボーナス
        return Math.min(100 + bonusScore, 120); // 最大120点
    } else {
        // 要求年数に達していない場合
        double shortage = requiredYears - employeeYears;
        double penalty = shortage * 15; // 1年不足で15点減点
        return Math.max(100 - penalty, 0);
    }
}
```

### 3.3 習熟度マッチスコア (Proficiency Match Score)

#### 3.3.1 計算式

```javascript
function calculateProficiencyMatchScore(requiredSkills, employeeSkills) {
  let totalScore = 0;
  let skillCount = 0;

  for (const requiredSkill of requiredSkills) {
    const employeeSkill = employeeSkills.find(
      (skill) => skill.technology.toLowerCase() === requiredSkill.toLowerCase()
    );

    if (employeeSkill) {
      const proficiencyScore = getProficiencyScore(employeeSkill.proficiency);
      totalScore += proficiencyScore;
      skillCount++;
    }
  }

  return skillCount > 0 ? totalScore / skillCount : 0;
}

function getProficiencyScore(proficiency) {
  const scores = {
    expert: 100,
    advanced: 85,
    intermediate: 70,
    beginner: 45,
  };
  return scores[proficiency] || 0;
}
```

### 3.4 総合スコア (Overall Score)

#### 3.4.1 計算式

```
総合スコア = (スキルマッチスコア × 0.5) +
            (経験年数マッチスコア × 0.3) +
            (習熟度マッチスコア × 0.2)
```

#### 3.4.2 重み付けの根拠

- **スキルマッチ**: 50% - 最も重要な要素
- **経験年数**: 30% - 実務経験の重要度
- **習熟度**: 20% - 技術レベルを示す指標

## 4. 推奨度判定ロジック

### 4.1 推奨度レベル

- **高推奨 (High)**: 85%以上
- **中推奨 (Medium)**: 70%以上 85%未満
- **低推奨 (Low)**: 70%未満

### 4.2 推奨度判定条件

```javascript
function determineRecommendationLevel(
  overallScore,
  skillMatchScore,
  missingSkills
) {
  // 基本判定
  if (overallScore >= 85) {
    return "high";
  } else if (overallScore >= 70) {
    return "medium";
  } else {
    return "low";
  }
}

function generateRecommendationComment(
  overallScore,
  matchedSkills,
  missingSkills,
  employee
) {
  const comments = [];

  // スコアに基づく基本コメント
  if (overallScore >= 90) {
    comments.push("非常に高い適合度です。即戦力として期待できます。");
  } else if (overallScore >= 80) {
    comments.push("高い適合度です。短期学習で対応可能です。");
  } else if (overallScore >= 70) {
    comments.push("基本的な適合度があります。研修・サポートが必要です。");
  } else {
    comments.push("適合度が低いです。大幅な学習・研修が必要です。");
  }

  // スキル詳細コメント
  if (matchedSkills.length > 0) {
    const topSkills = matchedSkills.slice(0, 3);
    comments.push(`特に${topSkills.join("、")}の経験が豊富です。`);
  }

  if (missingSkills.length > 0) {
    comments.push(`${missingSkills.join("、")}の習得が必要です。`);
  }

  return comments.join(" ");
}
```

## 5. スキル関連性マッピング

### 5.1 マッピングデータ構造

```sql
CREATE TABLE skill_mappings (
    id UUID PRIMARY KEY,
    from_technology VARCHAR(100) NOT NULL,
    to_technology VARCHAR(100) NOT NULL,
    compatibility_score DECIMAL(5,2) NOT NULL, -- 0.00-100.00
    learning_cost VARCHAR(20) NOT NULL, -- 'low', 'medium', 'high'
    learning_duration VARCHAR(50),
    description TEXT
);
```

### 5.2 マッピング取得ロジック

```javascript
function getSkillMapping(fromTech, toTech) {
  // 1. 直接マッピングを検索
  let mapping = findDirectMapping(fromTech, toTech);
  if (mapping) return mapping;

  // 2. 逆方向マッピングを検索
  mapping = findDirectMapping(toTech, fromTech);
  if (mapping) {
    return {
      ...mapping,
      compatibility_score: mapping.compatibility_score * 0.8, // 逆方向は80%の適合度
    };
  }

  // 3. デフォルト値（マッピングなし）
  return {
    compatibility_score: 0,
    learning_cost: "high",
    learning_duration: "3-6 months",
    description: "関連性が低いため、大幅な学習が必要です。",
  };
}
```

## 6. パフォーマンス最適化

### 6.1 キャッシュ戦略

```javascript
// スキルマッピングのキャッシュ
const skillMappingCache = new Map();

function getCachedSkillMapping(fromTech, toTech) {
  const key = `${fromTech}-${toTech}`;
  if (skillMappingCache.has(key)) {
    return skillMappingCache.get(key);
  }

  const mapping = getSkillMapping(fromTech, toTech);
  skillMappingCache.set(key, mapping);
  return mapping;
}

// 人員スキルのキャッシュ
const employeeSkillsCache = new Map();

function getCachedEmployeeSkills(employeeId) {
  if (employeeSkillsCache.has(employeeId)) {
    return employeeSkillsCache.get(employeeId);
  }

  const skills = getEmployeeSkills(employeeId);
  employeeSkillsCache.set(employeeId, skills);
  return skills;
}
```

### 6.2 バッチ処理

```javascript
async function batchSkillMatching(jobRequirementId, employeeIds) {
  const batchSize = 10;
  const results = [];

  for (let i = 0; i < employeeIds.length; i += batchSize) {
    const batch = employeeIds.slice(i, i + batchSize);
    const batchResults = await Promise.all(
      batch.map((employeeId) =>
        calculateSkillMatch(jobRequirementId, employeeId)
      )
    );
    results.push(...batchResults);
  }

  return results.sort((a, b) => b.overall_score - a.overall_score);
}
```

## 7. エラーハンドリング

### 7.1 エラーケース

```javascript
function handleMatchingErrors(error, context) {
  switch (error.type) {
    case "INVALID_JOB_REQUIREMENT":
      return {
        error: "無効な人員募集要項です。",
        code: "INVALID_JOB_REQUIREMENT",
      };

    case "NO_EMPLOYEES_FOUND":
      return {
        error: "マッチング対象の人員が見つかりません。",
        code: "NO_EMPLOYEES_FOUND",
      };

    case "SKILL_MAPPING_ERROR":
      return {
        error: "スキルマッピングの取得に失敗しました。",
        code: "SKILL_MAPPING_ERROR",
      };

    default:
      return {
        error: "マッチング処理中にエラーが発生しました。",
        code: "UNKNOWN_ERROR",
      };
  }
}
```

### 7.2 ログ出力

```javascript
function logMatchingProcess(jobRequirementId, employeeIds, results) {
  const logData = {
    timestamp: new Date().toISOString(),
    jobRequirementId,
    employeeCount: employeeIds.length,
    averageScore:
      results.reduce((sum, r) => sum + r.overall_score, 0) / results.length,
    highRecommendationCount: results.filter(
      (r) => r.recommendation_level === "high"
    ).length,
    processingTime: Date.now() - startTime,
  };

  console.log("Skill Matching Completed:", logData);
}
```

## 8. テストケース

### 8.1 単体テスト

```javascript
describe("Skill Matching Logic", () => {
  test("完全一致のスキルマッチング", () => {
    const requiredSkills = ["React", "Node.js"];
    const employeeSkills = [
      { technology: "React", proficiency: "advanced", experience_years: 3 },
      {
        technology: "Node.js",
        proficiency: "intermediate",
        experience_years: 2,
      },
    ];

    const score = calculateSkillMatchScore(requiredSkills, employeeSkills);
    expect(score).toBeGreaterThan(80);
  });

  test("関連スキルのマッチング", () => {
    const requiredSkills = ["React"];
    const employeeSkills = [
      { technology: "jQuery", proficiency: "advanced", experience_years: 5 },
    ];

    const score = calculateSkillMatchScore(requiredSkills, employeeSkills);
    expect(score).toBeGreaterThan(50);
  });

  test("経験年数のマッチング", () => {
    const requiredYears = 3;
    const employeeYears = 5;

    const score = calculateExperienceMatchScore(requiredYears, employeeYears);
    expect(score).toBeGreaterThan(100);
  });
});
```

### 8.2 統合テスト

```javascript
describe("End-to-End Skill Matching", () => {
  test("完全なマッチングフロー", async () => {
    const jobRequirement = {
      id: "job-1",
      required_skills: ["React", "Node.js"],
      preferred_skills: ["TypeScript"],
      experience_years: 3,
    };

    const employees = [
      {
        id: "emp-1",
        skills: [
          { technology: "React", proficiency: "advanced", experience_years: 4 },
          {
            technology: "Node.js",
            proficiency: "intermediate",
            experience_years: 2,
          },
          {
            technology: "TypeScript",
            proficiency: "beginner",
            experience_years: 0.5,
          },
        ],
      },
    ];

    const results = await executeSkillMatching(jobRequirement, employees);

    expect(results).toHaveLength(1);
    expect(results[0].overall_score).toBeGreaterThan(70);
    expect(results[0].recommendation_level).toBe("medium");
  });
});
```

## 9. 設定・カスタマイズ

### 9.1 設定可能なパラメータ

```javascript
const matchingConfig = {
  weights: {
    skillMatch: 0.5,
    experienceMatch: 0.3,
    proficiencyMatch: 0.2,
  },

  thresholds: {
    highRecommendation: 85,
    mediumRecommendation: 70,
    lowRecommendation: 0,
  },

  penalties: {
    missingRequiredSkill: 20,
    insufficientExperience: 15,
    lowProficiency: 10,
  },

  bonuses: {
    excessExperience: 5,
    expertProficiency: 10,
    preferredSkillMatch: 5,
  },
};
```

### 9.2 動的設定更新

```javascript
function updateMatchingConfig(newConfig) {
  // 設定の検証
  if (validateConfig(newConfig)) {
    matchingConfig = { ...matchingConfig, ...newConfig };
    // キャッシュのクリア
    clearCaches();
    return true;
  }
  return false;
}
```
