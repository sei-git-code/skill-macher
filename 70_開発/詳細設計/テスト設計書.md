# テスト設計書

## 1. テスト設計概要

### 1.1 設計方針
- **テストピラミッド**: 単体テスト > 統合テスト > E2Eテスト
- **品質保証**: 自動テストによる継続的な品質確保
- **カバレッジ**: 80%以上のコードカバレッジ目標
- **継続的テスト**: CI/CDパイプラインでの自動実行

### 1.2 テスト戦略
```
┌─────────────────────────────────────────┐
│              E2E Tests                  │
│         (Selenium + TestContainers)     │
│                 10%                     │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│           Integration Tests              │
│         (Spring Boot Test + JPA)        │
│                 20%                     │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│            Unit Tests                   │
│         (JUnit 5 + Mockito)            │
│                 70%                     │
└─────────────────────────────────────────┘
```

## 2. 単体テスト設計

### 2.1 テストフレームワーク
```xml
<dependencies>
    <!-- JUnit 5 -->
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- Mockito -->
    <dependency>
        <groupId>org.mockito</groupId>
        <artifactId>mockito-core</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- AssertJ -->
    <dependency>
        <groupId>org.assertj</groupId>
        <artifactId>assertj-core</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- Spring Boot Test -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### 2.2 Service層テスト
```java
package com.ses.sales.support.service;

import com.ses.sales.support.entity.User;
import com.ses.sales.support.entity.UserRole;
import com.ses.sales.support.repository.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.security.crypto.password.PasswordEncoder;

import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private PasswordEncoder passwordEncoder;
    
    @InjectMocks
    private UserService userService;
    
    private User testUser;
    
    @BeforeEach
    void setUp() {
        testUser = new User();
        testUser.setId("user-1");
        testUser.setEmail("test@example.com");
        testUser.setName("Test User");
        testUser.setRole(UserRole.USER);
        testUser.setIsActive(true);
    }
    
    @Test
    void createUser_ShouldCreateUserSuccessfully() {
        // Given
        String email = "new@example.com";
        String password = "password123";
        String name = "New User";
        UserRole role = UserRole.USER;
        
        when(userRepository.existsByEmail(email)).thenReturn(false);
        when(passwordEncoder.encode(password)).thenReturn("encoded-password");
        when(userRepository.save(any(User.class))).thenReturn(testUser);
        
        // When
        User result = userService.createUser(email, password, name, role);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getEmail()).isEqualTo(email);
        assertThat(result.getName()).isEqualTo(name);
        assertThat(result.getRole()).isEqualTo(role);
        
        verify(userRepository).existsByEmail(email);
        verify(passwordEncoder).encode(password);
        verify(userRepository).save(any(User.class));
    }
    
    @Test
    void createUser_ShouldThrowException_WhenEmailAlreadyExists() {
        // Given
        String email = "existing@example.com";
        String password = "password123";
        String name = "New User";
        UserRole role = UserRole.USER;
        
        when(userRepository.existsByEmail(email)).thenReturn(true);
        
        // When & Then
        assertThatThrownBy(() -> userService.createUser(email, password, name, role))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("Email already exists: " + email);
        
        verify(userRepository).existsByEmail(email);
        verify(userRepository, never()).save(any(User.class));
    }
    
    @Test
    void findByEmail_ShouldReturnUser_WhenUserExists() {
        // Given
        String email = "test@example.com";
        when(userRepository.findByEmail(email)).thenReturn(Optional.of(testUser));
        
        // When
        Optional<User> result = userService.findByEmail(email);
        
        // Then
        assertThat(result).isPresent();
        assertThat(result.get().getEmail()).isEqualTo(email);
        verify(userRepository).findByEmail(email);
    }
    
    @Test
    void findByEmail_ShouldReturnEmpty_WhenUserNotExists() {
        // Given
        String email = "nonexistent@example.com";
        when(userRepository.findByEmail(email)).thenReturn(Optional.empty());
        
        // When
        Optional<User> result = userService.findByEmail(email);
        
        // Then
        assertThat(result).isEmpty();
        verify(userRepository).findByEmail(email);
    }
}
```

### 2.3 Controller層テスト
```java
package com.ses.sales.support.controller;

import com.ses.sales.support.entity.JobRequirement;
import com.ses.sales.support.entity.JobStatus;
import com.ses.sales.support.entity.User;
import com.ses.sales.support.service.JobRequirementService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;

import java.util.Arrays;
import java.util.List;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.when;
import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.csrf;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@WebMvcTest(JobRequirementController.class)
class JobRequirementControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private JobRequirementService jobRequirementService;
    
    private JobRequirement testJobRequirement;
    private User testUser;
    
    @BeforeEach
    void setUp() {
        testUser = new User();
        testUser.setId("user-1");
        testUser.setEmail("test@example.com");
        testUser.setName("Test User");
        
        testJobRequirement = new JobRequirement();
        testJobRequirement.setId("job-1");
        testJobRequirement.setProjectName("Test Project");
        testJobRequirement.setStatus(JobStatus.ACTIVE);
        testJobRequirement.setCreatedBy(testUser);
    }
    
    @Test
    @WithMockUser
    void listJobRequirements_ShouldReturnJobRequirementsList() throws Exception {
        // Given
        List<JobRequirement> jobRequirements = Arrays.asList(testJobRequirement);
        Page<JobRequirement> page = new PageImpl<>(jobRequirements, PageRequest.of(0, 20), 1);
        
        when(jobRequirementService.findByCreatedBy(any(User.class), any(Pageable.class)))
            .thenReturn(page);
        
        // When & Then
        mockMvc.perform(get("/job-requirements"))
            .andExpect(status().isOk())
            .andExpect(view().name("job-requirements/list"))
            .andExpect(model().attributeExists("jobRequirements"))
            .andExpect(model().attribute("jobRequirements", page));
    }
    
    @Test
    @WithMockUser
    void viewJobRequirement_ShouldReturnJobRequirementView() throws Exception {
        // Given
        when(jobRequirementService.findById("job-1"))
            .thenReturn(Optional.of(testJobRequirement));
        
        // When & Then
        mockMvc.perform(get("/job-requirements/job-1"))
            .andExpect(status().isOk())
            .andExpect(view().name("job-requirements/view"))
            .andExpect(model().attributeExists("jobRequirement"))
            .andExpect(model().attribute("jobRequirement", testJobRequirement));
    }
    
    @Test
    @WithMockUser
    void createJobRequirement_ShouldCreateJobRequirement() throws Exception {
        // Given
        when(jobRequirementService.createJobRequirement(any(JobRequirement.class), any(User.class)))
            .thenReturn(testJobRequirement);
        
        // When & Then
        mockMvc.perform(post("/job-requirements")
                .with(csrf())
                .param("projectName", "New Project")
                .param("experienceYears", "3")
                .param("requiredSkills", "Java,Spring"))
            .andExpect(status().is3xxRedirection())
            .andExpect(redirectedUrl("/job-requirements/job-1"))
            .andExpect(flash().attributeExists("successMessage"));
    }
}
```

## 3. 統合テスト設計

### 3.1 テストフレームワーク
```xml
<dependencies>
    <!-- TestContainers -->
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
    
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>postgresql</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- Spring Boot Test -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### 3.2 Repository層テスト
```java
package com.ses.sales.support.repository;

import com.ses.sales.support.entity.JobRequirement;
import com.ses.sales.support.entity.JobStatus;
import com.ses.sales.support.entity.User;
import com.ses.sales.support.entity.UserRole;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.boot.test.autoconfigure.orm.jpa.TestEntityManager;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import java.util.List;
import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
@Testcontainers
class JobRequirementRepositoryTest {
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private JobRequirementRepository jobRequirementRepository;
    
    private User testUser;
    private JobRequirement testJobRequirement;
    
    @BeforeEach
    void setUp() {
        testUser = new User();
        testUser.setEmail("test@example.com");
        testUser.setName("Test User");
        testUser.setRole(UserRole.USER);
        testUser.setIsActive(true);
        entityManager.persistAndFlush(testUser);
        
        testJobRequirement = new JobRequirement();
        testJobRequirement.setProjectName("Test Project");
        testJobRequirement.setStatus(JobStatus.ACTIVE);
        testJobRequirement.setCreatedBy(testUser);
        entityManager.persistAndFlush(testJobRequirement);
    }
    
    @Test
    void findByStatus_ShouldReturnJobRequirementsWithStatus() {
        // When
        Pageable pageable = PageRequest.of(0, 10);
        Page<JobRequirement> result = jobRequirementRepository.findByStatus(JobStatus.ACTIVE, pageable);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getContent()).hasSize(1);
        assertThat(result.getContent().get(0).getStatus()).isEqualTo(JobStatus.ACTIVE);
    }
    
    @Test
    void findByCreatedBy_ShouldReturnJobRequirementsByUser() {
        // When
        Pageable pageable = PageRequest.of(0, 10);
        Page<JobRequirement> result = jobRequirementRepository.findByCreatedBy(testUser, pageable);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getContent()).hasSize(1);
        assertThat(result.getContent().get(0).getCreatedBy()).isEqualTo(testUser);
    }
    
    @Test
    void findByKeyword_ShouldReturnJobRequirementsMatchingKeyword() {
        // When
        List<JobRequirement> result = jobRequirementRepository.findByKeyword("Test");
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result).hasSize(1);
        assertThat(result.get(0).getProjectName()).contains("Test");
    }
}
```

### 3.3 Service層統合テスト
```java
package com.ses.sales.support.service;

import com.ses.sales.support.entity.JobRequirement;
import com.ses.sales.support.entity.JobStatus;
import com.ses.sales.support.entity.User;
import com.ses.sales.support.entity.UserRole;
import com.ses.sales.support.repository.JobRequirementRepository;
import com.ses.sales.support.repository.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.transaction.annotation.Transactional;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import java.util.Arrays;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
@ActiveProfiles("test")
@Testcontainers
@Transactional
class JobRequirementServiceIntegrationTest {
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");
    
    @Autowired
    private JobRequirementService jobRequirementService;
    
    @Autowired
    private JobRequirementRepository jobRequirementRepository;
    
    @Autowired
    private UserRepository userRepository;
    
    private User testUser;
    
    @BeforeEach
    void setUp() {
        testUser = new User();
        testUser.setEmail("test@example.com");
        testUser.setName("Test User");
        testUser.setRole(UserRole.USER);
        testUser.setIsActive(true);
        testUser = userRepository.save(testUser);
    }
    
    @Test
    void createJobRequirement_ShouldCreateAndSaveJobRequirement() {
        // Given
        JobRequirement jobRequirement = new JobRequirement();
        jobRequirement.setProjectName("Integration Test Project");
        jobRequirement.setRequiredSkills(Arrays.asList("Java", "Spring"));
        jobRequirement.setExperienceYears(3);
        
        // When
        JobRequirement result = jobRequirementService.createJobRequirement(jobRequirement, testUser);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getId()).isNotNull();
        assertThat(result.getProjectName()).isEqualTo("Integration Test Project");
        assertThat(result.getCreatedBy()).isEqualTo(testUser);
        assertThat(result.getStatus()).isEqualTo(JobStatus.ACTIVE);
        
        // Verify in database
        Optional<JobRequirement> saved = jobRequirementRepository.findById(result.getId());
        assertThat(saved).isPresent();
        assertThat(saved.get().getProjectName()).isEqualTo("Integration Test Project");
    }
    
    @Test
    void updateJobRequirement_ShouldUpdateExistingJobRequirement() {
        // Given
        JobRequirement jobRequirement = new JobRequirement();
        jobRequirement.setProjectName("Original Project");
        jobRequirement.setExperienceYears(2);
        jobRequirement = jobRequirementService.createJobRequirement(jobRequirement, testUser);
        
        JobRequirement updatedJobRequirement = new JobRequirement();
        updatedJobRequirement.setProjectName("Updated Project");
        updatedJobRequirement.setExperienceYears(5);
        
        // When
        JobRequirement result = jobRequirementService.updateJobRequirement(jobRequirement.getId(), updatedJobRequirement);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getProjectName()).isEqualTo("Updated Project");
        assertThat(result.getExperienceYears()).isEqualTo(5);
        
        // Verify in database
        Optional<JobRequirement> saved = jobRequirementRepository.findById(jobRequirement.getId());
        assertThat(saved).isPresent();
        assertThat(saved.get().getProjectName()).isEqualTo("Updated Project");
    }
}
```

## 4. E2Eテスト設計

### 4.1 テストフレームワーク
```xml
<dependencies>
    <!-- Selenium -->
    <dependency>
        <groupId>org.seleniumhq.selenium</groupId>
        <artifactId>selenium-java</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- WebDriverManager -->
    <dependency>
        <groupId>io.github.bonigarcia</groupId>
        <artifactId>webdrivermanager</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- TestContainers -->
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>selenium</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### 4.2 E2Eテスト
```java
package com.ses.sales.support.e2e;

import com.ses.sales.support.entity.User;
import com.ses.sales.support.entity.UserRole;
import com.ses.sales.support.repository.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.server.LocalServerPort;
import org.springframework.test.context.ActiveProfiles;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import java.time.Duration;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("test")
@Testcontainers
class JobRequirementE2ETest {
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");
    
    @LocalServerPort
    private int port;
    
    @Autowired
    private UserRepository userRepository;
    
    private WebDriver driver;
    private WebDriverWait wait;
    
    @BeforeEach
    void setUp() {
        ChromeOptions options = new ChromeOptions();
        options.addArguments("--headless");
        options.addArguments("--no-sandbox");
        options.addArguments("--disable-dev-shm-usage");
        
        driver = new ChromeDriver(options);
        wait = new WebDriverWait(driver, Duration.ofSeconds(10));
        
        // Create test user
        User testUser = new User();
        testUser.setEmail("test@example.com");
        testUser.setName("Test User");
        testUser.setRole(UserRole.USER);
        testUser.setIsActive(true);
        userRepository.save(testUser);
    }
    
    @Test
    void createJobRequirement_ShouldCreateSuccessfully() {
        // Given
        String baseUrl = "http://localhost:" + port;
        driver.get(baseUrl + "/login");
        
        // Login
        WebElement emailInput = driver.findElement(By.name("email"));
        WebElement passwordInput = driver.findElement(By.name("password"));
        WebElement loginButton = driver.findElement(By.type("submit"));
        
        emailInput.sendKeys("test@example.com");
        passwordInput.sendKeys("password123");
        loginButton.click();
        
        // Navigate to job requirements
        driver.get(baseUrl + "/job-requirements");
        
        // Click create button
        WebElement createButton = driver.findElement(By.linkText("新規作成"));
        createButton.click();
        
        // Fill form
        WebElement projectNameInput = driver.findElement(By.name("projectName"));
        WebElement experienceYearsInput = driver.findElement(By.name("experienceYears"));
        WebElement submitButton = driver.findElement(By.type("submit"));
        
        projectNameInput.sendKeys("E2E Test Project");
        experienceYearsInput.sendKeys("3");
        submitButton.click();
        
        // Verify success
        WebElement successMessage = wait.until(driver -> 
            driver.findElement(By.className("alert-success")));
        assertThat(successMessage.getText()).contains("作成しました");
        
        // Verify project name in list
        WebElement projectName = driver.findElement(By.xpath("//td[contains(text(), 'E2E Test Project')]"));
        assertThat(projectName).isNotNull();
    }
    
    @Test
    void searchJobRequirement_ShouldReturnResults() {
        // Given
        String baseUrl = "http://localhost:" + port;
        driver.get(baseUrl + "/login");
        
        // Login (same as above)
        // ... login code ...
        
        // Navigate to job requirements
        driver.get(baseUrl + "/job-requirements");
        
        // Search
        WebElement searchInput = driver.findElement(By.name("keyword"));
        WebElement searchButton = driver.findElement(By.type("submit"));
        
        searchInput.sendKeys("Test");
        searchButton.click();
        
        // Verify results
        WebElement resultsTable = wait.until(driver -> 
            driver.findElement(By.className("table")));
        assertThat(resultsTable).isNotNull();
    }
}
```

## 5. テスト設定

### 5.1 テスト用設定 (application-test.yml)
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/testdb
    username: test
    password: test
    driver-class-name: org.postgresql.Driver
  
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
  
  thymeleaf:
    cache: false

logging:
  level:
    com.ses.sales.support: DEBUG
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
```

### 5.2 テスト用データベース設定
```java
package com.ses.sales.support.config;

import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Primary;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.testcontainers.containers.PostgreSQLContainer;

@TestConfiguration
public class TestDatabaseConfig {
    
    @Bean
    @Primary
    public PostgreSQLContainer<?> postgresContainer() {
        PostgreSQLContainer<?> container = new PostgreSQLContainer<>("postgres:15")
                .withDatabaseName("testdb")
                .withUsername("test")
                .withPassword("test");
        container.start();
        return container;
    }
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        PostgreSQLContainer<?> container = new PostgreSQLContainer<>("postgres:15")
                .withDatabaseName("testdb")
                .withUsername("test")
                .withPassword("test");
        container.start();
        
        registry.add("spring.datasource.url", container::getJdbcUrl);
        registry.add("spring.datasource.username", container::getUsername);
        registry.add("spring.datasource.password", container::getPassword);
    }
}
```

## 6. テスト実行

### 6.1 Maven設定
```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <version>3.0.0</version>
            <configuration>
                <includes>
                    <include>**/*Test.java</include>
                    <include>**/*Tests.java</include>
                </includes>
            </configuration>
        </plugin>
        
        <plugin>
            <groupId>org.jacoco</groupId>
            <artifactId>jacoco-maven-plugin</artifactId>
            <version>0.8.8</version>
            <executions>
                <execution>
                    <goals>
                        <goal>prepare-agent</goal>
                    </goals>
                </execution>
                <execution>
                    <id>report</id>
                    <phase>test</phase>
                    <goals>
                        <goal>report</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

### 6.2 テスト実行コマンド
```bash
# 全テスト実行
mvn test

# 単体テストのみ
mvn test -Dtest="*Test"

# 統合テストのみ
mvn test -Dtest="*IntegrationTest"

# E2Eテストのみ
mvn test -Dtest="*E2ETest"

# カバレッジレポート生成
mvn clean test jacoco:report
```

## 7. テスト品質管理

### 7.1 コードカバレッジ目標
- **全体カバレッジ**: 80%以上
- **Service層**: 90%以上
- **Controller層**: 80%以上
- **Repository層**: 85%以上

### 7.2 テスト品質チェック
```java
package com.ses.sales.support.test;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.Tag;

@Tag("unit")
class TestQualityExample {
    
    @Test
    @DisplayName("ユーザー作成 - 正常ケース")
    void createUser_Success() {
        // Given-When-Then パターンで記述
    }
    
    @Test
    @DisplayName("ユーザー作成 - メール重複エラー")
    void createUser_EmailDuplicateError() {
        // エラーケースのテスト
    }
}
```

### 7.3 テストデータ管理
```java
package com.ses.sales.support.test;

import com.ses.sales.support.entity.User;
import com.ses.sales.support.entity.UserRole;

public class TestDataFactory {
    
    public static User createTestUser() {
        User user = new User();
        user.setEmail("test@example.com");
        user.setName("Test User");
        user.setRole(UserRole.USER);
        user.setIsActive(true);
        return user;
    }
    
    public static User createAdminUser() {
        User user = createTestUser();
        user.setRole(UserRole.ADMIN);
        return user;
    }
}
```

## 8. CI/CD統合

### 8.1 GitHub Actions設定
```yaml
name: Test Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Run tests
      run: mvn clean test
    
    - name: Generate coverage report
      run: mvn jacoco:report
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: target/site/jacoco/jacoco.xml
```

## 9. テスト戦略

### 9.1 テストピラミッド実装
- **単体テスト**: 70% - 高速、低コスト
- **統合テスト**: 20% - 中速、中コスト
- **E2Eテスト**: 10% - 低速、高コスト

### 9.2 テスト実行戦略
- **開発時**: 単体テストのみ
- **プルリクエスト**: 単体 + 統合テスト
- **本番デプロイ前**: 全テスト実行

### 9.3 テスト保守性
- **テストデータ**: ファクトリーパターンで管理
- **テスト設定**: 環境別に分離
- **テスト実行**: 並列実行で高速化
