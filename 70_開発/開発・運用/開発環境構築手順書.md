# 開発環境構築手順書

## 1. 概要

### 1.1 目的
SES営業支援ツールの開発環境を構築するための手順書です。

### 1.2 対象環境
- **OS**: macOS, Windows, Linux
- **Java**: OpenJDK 17
- **IDE**: IntelliJ IDEA
- **データベース**: Supabase PostgreSQL
- **ツール**: Maven, Git, Docker

## 2. 前提条件

### 2.1 必要なアカウント
- **GitHub**: ソースコード管理
- **Supabase**: データベースサービス
- **Oracle Cloud**: インフラストラクチャ（本番環境）

### 2.2 必要なソフトウェア
- Java 17以上
- Maven 3.8以上
- Git 2.30以上
- IntelliJ IDEA（推奨）
- Docker（オプション）

## 3. 開発環境構築手順

### 3.1 Java環境の構築

#### 3.1.1 macOS
```bash
# Homebrewを使用してインストール
brew install openjdk@17

# 環境変数の設定
echo 'export JAVA_HOME=/opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk/Contents/Home' >> ~/.zshrc
echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.zshrc
source ~/.zshrc

# インストール確認
java -version
javac -version
```

#### 3.1.2 Windows
```powershell
# Chocolateyを使用してインストール
choco install openjdk17

# 環境変数の設定（システム環境変数）
JAVA_HOME=C:\Program Files\OpenJDK\jdk-17.0.2
PATH=%JAVA_HOME%\bin;%PATH%

# インストール確認
java -version
javac -version
```

#### 3.1.3 Linux (Ubuntu/Debian)
```bash
# OpenJDK 17のインストール
sudo apt update
sudo apt install openjdk-17-jdk

# 環境変数の設定
echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64' >> ~/.bashrc
echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# インストール確認
java -version
javac -version
```

### 3.2 Maven環境の構築

#### 3.2.1 macOS
```bash
# Homebrewを使用してインストール
brew install maven

# インストール確認
mvn -version
```

#### 3.2.2 Windows
```powershell
# Chocolateyを使用してインストール
choco install maven

# インストール確認
mvn -version
```

#### 3.2.3 Linux
```bash
# Mavenのインストール
sudo apt install maven

# インストール確認
mvn -version
```

### 3.3 Git環境の構築

#### 3.3.1 Gitのインストール
```bash
# macOS
brew install git

# Windows
choco install git

# Linux
sudo apt install git
```

#### 3.3.2 Git設定
```bash
# ユーザー情報の設定
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# デフォルトブランチ名の設定
git config --global init.defaultBranch main

# 設定確認
git config --list
```

### 3.4 IntelliJ IDEAの設定

#### 3.4.1 インストール
- [IntelliJ IDEA Community Edition](https://www.jetbrains.com/idea/download/) をダウンロード
- インストール手順に従ってインストール

#### 3.4.2 プロジェクト設定
1. **プロジェクトを開く**
   - IntelliJ IDEAを起動
   - "Open"を選択
   - プロジェクトルートディレクトリを選択

2. **JDK設定**
   - File → Project Structure → Project
   - Project SDK: OpenJDK 17を選択

3. **Maven設定**
   - File → Settings → Build, Execution, Deployment → Build Tools → Maven
   - Maven home path: システムのMavenパスを設定
   - User settings file: 必要に応じてカスタム設定ファイルを指定

4. **プラグインのインストール**
   - File → Settings → Plugins
   - 以下のプラグインをインストール:
     - Lombok
     - Spring Boot
     - Thymeleaf
     - Database Navigator

## 4. Supabase環境構築

### 4.1 Supabaseプロジェクト作成

#### 4.1.1 アカウント作成
1. [Supabase](https://supabase.com/) にアクセス
2. "Start your project"をクリック
3. GitHubアカウントでサインアップ

#### 4.1.2 プロジェクト作成
1. "New Project"をクリック
2. プロジェクト情報を入力:
   - **Name**: ses-sales-support-dev
   - **Database Password**: 強力なパスワードを設定
   - **Region**: Asia Pacific (Tokyo)
3. "Create new project"をクリック

#### 4.1.3 データベース設定
1. プロジェクトダッシュボードで"Settings" → "Database"を選択
2. 接続情報を確認:
   - **Host**: db.xxxxxxxxxxxx.supabase.co
   - **Port**: 5432
   - **Database**: postgres
   - **Username**: postgres
   - **Password**: 設定したパスワード

### 4.2 データベーススキーマ作成

#### 4.2.1 SQL Editorでスキーマ作成
```sql
-- ユーザーテーブル
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL DEFAULT 'USER',
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ユーザープロフィールテーブル
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    bio TEXT,
    avatar_url VARCHAR(500),
    phone VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 人員募集要項テーブル
CREATE TABLE job_requirements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_name VARCHAR(255) NOT NULL,
    client_name VARCHAR(255),
    description TEXT,
    experience_years INTEGER NOT NULL,
    budget_range VARCHAR(100),
    start_date DATE,
    end_date DATE,
    location VARCHAR(255),
    work_style VARCHAR(50),
    additional_requirements TEXT,
    status VARCHAR(50) NOT NULL DEFAULT 'ACTIVE',
    created_by UUID REFERENCES users(id) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 必須スキルテーブル
CREATE TABLE job_required_skills (
    job_requirement_id UUID REFERENCES job_requirements(id) ON DELETE CASCADE,
    skill VARCHAR(100) NOT NULL,
    PRIMARY KEY (job_requirement_id, skill)
);

-- 希望スキルテーブル
CREATE TABLE job_preferred_skills (
    job_requirement_id UUID REFERENCES job_requirements(id) ON DELETE CASCADE,
    skill VARCHAR(100) NOT NULL,
    PRIMARY KEY (job_requirement_id, skill)
);

-- SES人員テーブル
CREATE TABLE employees (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255),
    phone VARCHAR(20),
    birth_date DATE,
    gender VARCHAR(20),
    address TEXT,
    education VARCHAR(255),
    certification JSONB,
    availability VARCHAR(50) NOT NULL DEFAULT 'AVAILABLE',
    hourly_rate INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 人員スキルテーブル
CREATE TABLE employee_skills (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID REFERENCES employees(id) ON DELETE CASCADE,
    technology VARCHAR(100) NOT NULL,
    proficiency VARCHAR(50) NOT NULL,
    experience_years DECIMAL(3,1) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- スキルマッピングテーブル
CREATE TABLE skill_mappings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    from_technology VARCHAR(100) NOT NULL,
    to_technology VARCHAR(100) NOT NULL,
    compatibility_score INTEGER NOT NULL,
    learning_cost INTEGER NOT NULL,
    adaptation_success_rate INTEGER NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(from_technology, to_technology)
);

-- マッチング結果テーブル
CREATE TABLE matching_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_requirement_id UUID REFERENCES job_requirements(id) ON DELETE CASCADE,
    employee_id UUID REFERENCES employees(id) ON DELETE CASCADE,
    skill_match_score DECIMAL(5,2) NOT NULL,
    experience_match_score DECIMAL(5,2) NOT NULL,
    proficiency_match_score DECIMAL(5,2) NOT NULL,
    overall_score DECIMAL(5,2) NOT NULL,
    recommendation_level VARCHAR(50) NOT NULL,
    detailed_analysis JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- システムログテーブル
CREATE TABLE system_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(100),
    resource_id UUID,
    details JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックスの作成
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_job_requirements_status ON job_requirements(status);
CREATE INDEX idx_job_requirements_created_by ON job_requirements(created_by);
CREATE INDEX idx_employees_availability ON employees(availability);
CREATE INDEX idx_employee_skills_technology ON employee_skills(technology);
CREATE INDEX idx_matching_results_job_requirement ON matching_results(job_requirement_id);
CREATE INDEX idx_matching_results_employee ON matching_results(employee_id);
CREATE INDEX idx_system_logs_user_id ON system_logs(user_id);
CREATE INDEX idx_system_logs_created_at ON system_logs(created_at);
```

#### 4.2.2 Row Level Security (RLS) 設定
```sql
-- RLSを有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE job_requirements ENABLE ROW LEVEL SECURITY;
ALTER TABLE employees ENABLE ROW LEVEL SECURITY;
ALTER TABLE matching_results ENABLE ROW LEVEL SECURITY;

-- ユーザーテーブルのポリシー
CREATE POLICY "Users can view own data" ON users
    FOR SELECT USING (auth.uid()::text = id);

CREATE POLICY "Users can update own data" ON users
    FOR UPDATE USING (auth.uid()::text = id);

-- 管理者は全データにアクセス可能
CREATE POLICY "Admins can view all users" ON users
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM users 
            WHERE id = auth.uid()::text 
            AND role = 'ADMIN'
        )
    );

-- 人員募集要項のポリシー
CREATE POLICY "Users can view job requirements" ON job_requirements
    FOR SELECT USING (true);

CREATE POLICY "Users can create job requirements" ON job_requirements
    FOR INSERT WITH CHECK (auth.uid()::text = created_by::text);

CREATE POLICY "Users can update own job requirements" ON job_requirements
    FOR UPDATE USING (auth.uid()::text = created_by::text);
```

### 4.3 初期データの投入

#### 4.3.1 スキルマッピングデータ
```sql
-- スキルマッピングの初期データ
INSERT INTO skill_mappings (from_technology, to_technology, compatibility_score, learning_cost, adaptation_success_rate) VALUES
('jQuery', 'React', 75, 3, 80),
('jQuery', 'Vue.js', 70, 2, 75),
('jQuery', 'Angular', 65, 4, 70),
('JavaScript', 'TypeScript', 90, 2, 95),
('JavaScript', 'Node.js', 85, 3, 90),
('Java', 'Spring Boot', 90, 2, 95),
('Java', 'Spring Framework', 85, 3, 90),
('Java', 'Hibernate', 80, 3, 85),
('Python', 'Django', 85, 3, 90),
('Python', 'Flask', 80, 2, 85),
('Python', 'FastAPI', 75, 3, 80),
('PHP', 'Laravel', 80, 3, 85),
('PHP', 'Symfony', 75, 4, 80),
('C#', '.NET Core', 90, 2, 95),
('C#', 'ASP.NET', 85, 3, 90),
('Ruby', 'Rails', 85, 3, 90),
('Go', 'Gin', 80, 3, 85),
('Rust', 'Actix', 75, 4, 80),
('MySQL', 'PostgreSQL', 85, 2, 90),
('MongoDB', 'PostgreSQL', 60, 4, 65),
('Redis', 'Memcached', 80, 2, 85),
('Docker', 'Kubernetes', 75, 4, 80),
('AWS', 'Azure', 70, 3, 75),
('AWS', 'GCP', 70, 3, 75);
```

#### 4.3.2 テストユーザーデータ
```sql
-- テストユーザーの作成
INSERT INTO users (email, password_hash, name, role) VALUES
('admin@example.com', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj4J8K8K8K8K', 'Admin User', 'ADMIN'),
('manager@example.com', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj4J8K8K8K8K', 'Manager User', 'MANAGER'),
('user@example.com', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj4J8K8K8K8K', 'Test User', 'USER');
```

## 5. プロジェクト設定

### 5.1 プロジェクトのクローン
```bash
# リポジトリをクローン
git clone https://github.com/your-org/ses-sales-support-tool.git
cd ses-sales-support-tool

# ブランチの確認
git branch -a

# 開発ブランチに切り替え
git checkout develop
```

### 5.2 環境変数の設定

#### 5.2.1 開発環境用設定ファイル作成
```bash
# .env.dev ファイルを作成
cat > .env.dev << EOF
# アプリケーション設定
SPRING_PROFILES_ACTIVE=dev
PORT=8080

# データベース設定
SUPABASE_DATABASE_URL=jdbc:postgresql://db.xxxxxxxxxxxx.supabase.co:5432/postgres
SUPABASE_DATABASE_USERNAME=postgres
SUPABASE_DATABASE_PASSWORD=your-password

# JWT設定
JWT_SECRET=dev-secret-key-for-development-only

# Supabase設定
SUPABASE_URL=https://xxxxxxxxxxxx.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# ログ設定
LOG_FILE_PATH=logs/application-dev.log
EOF
```

#### 5.2.2 環境変数の読み込み
```bash
# .env.dev を読み込み
source .env.dev

# 環境変数の確認
echo $SPRING_PROFILES_ACTIVE
echo $SUPABASE_DATABASE_URL
```

### 5.3 Maven設定

#### 5.3.1 settings.xml の設定
```xml
<!-- ~/.m2/settings.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 
          http://maven.apache.org/xsd/settings-1.0.0.xsd">
    
    <profiles>
        <profile>
            <id>dev</id>
            <properties>
                <spring.profiles.active>dev</spring.profiles.active>
            </properties>
        </profile>
    </profiles>
    
    <activeProfiles>
        <activeProfile>dev</activeProfile>
    </activeProfiles>
</settings>
```

## 6. アプリケーションの起動

### 6.1 依存関係のインストール
```bash
# Maven依存関係のダウンロード
mvn clean install

# 依存関係の確認
mvn dependency:tree
```

### 6.2 データベース接続テスト
```bash
# データベース接続のテスト
mvn spring-boot:run -Dspring-boot.run.arguments="--spring.profiles.active=dev"

# 接続確認（別ターミナルで）
curl http://localhost:8080/actuator/health
```

### 6.3 アプリケーションの起動
```bash
# 開発環境で起動
mvn spring-boot:run -Dspring-boot.run.profiles=dev

# または
java -jar target/ses-sales-support-tool-1.0.0.jar --spring.profiles.active=dev
```

### 6.4 起動確認
1. **ブラウザでアクセス**
   - http://localhost:8080
   - ログイン画面が表示されることを確認

2. **ヘルスチェック**
   - http://localhost:8080/actuator/health
   - データベース接続状態を確認

3. **ログの確認**
   - コンソールにログが出力されることを確認
   - エラーがないことを確認

## 7. 開発ツールの設定

### 7.1 IntelliJ IDEA設定

#### 7.1.1 コードスタイル設定
1. File → Settings → Editor → Code Style → Java
2. "Scheme"で"Project"を選択
3. 以下の設定を適用:
   - Tab size: 4
   - Indent: 4
   - Continuation indent: 8
   - Line length: 120

#### 7.1.2 ライブテンプレート設定
1. File → Settings → Editor → Live Templates
2. 以下のテンプレートを追加:

```java
// @Test テンプレート
@Test
@DisplayName("$DESCRIPTION$")
void $METHOD_NAME$() {
    // Given
    $END$
    
    // When
    
    // Then
}
```

#### 7.1.3 プラグイン設定
1. File → Settings → Plugins
2. 以下のプラグインを有効化:
   - Lombok
   - Spring Boot
   - Thymeleaf
   - Database Navigator
   - GitToolBox

### 7.2 Git設定

#### 7.2.1 .gitignore 設定
```gitignore
# IDE
.idea/
*.iml
*.ipr
*.iws

# Maven
target/
pom.xml.tag
pom.xml.releaseBackup
pom.xml.versionsBackup
pom.xml.next
release.properties
dependency-reduced-pom.xml
buildNumber.properties
.mvn/timing.properties
.mvn/wrapper/maven-wrapper.jar

# Logs
logs/
*.log

# Environment
.env
.env.local
.env.dev
.env.staging
.env.prod

# OS
.DS_Store
Thumbs.db

# Temporary files
*.tmp
*.temp
```

#### 7.2.2 Git Hooks設定
```bash
# pre-commit hook の設定
cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash

# コードフォーマットチェック
mvn spotless:check

# テスト実行
mvn test

# ビルドチェック
mvn compile
EOF

chmod +x .git/hooks/pre-commit
```

## 8. トラブルシューティング

### 8.1 よくある問題と解決方法

#### 8.1.1 Java関連
```bash
# Java バージョンの確認
java -version

# JAVA_HOME の確認
echo $JAVA_HOME

# 複数バージョンがある場合の切り替え（macOS）
export JAVA_HOME=$(/usr/libexec/java_home -v 17)
```

#### 8.1.2 Maven関連
```bash
# Maven バージョンの確認
mvn -version

# 依存関係のクリア
mvn dependency:purge-local-repository

# ローカルリポジトリのクリア
rm -rf ~/.m2/repository
mvn clean install
```

#### 8.1.3 データベース接続
```bash
# 接続文字列の確認
echo $SUPABASE_DATABASE_URL

# ネットワーク接続の確認
ping db.xxxxxxxxxxxx.supabase.co

# ポート接続の確認
telnet db.xxxxxxxxxxxx.supabase.co 5432
```

#### 8.1.4 ポート競合
```bash
# ポート使用状況の確認
lsof -i :8080

# プロセスの終了
kill -9 <PID>

# 別のポートで起動
mvn spring-boot:run -Dspring-boot.run.arguments="--server.port=8081"
```

### 8.2 ログの確認方法

#### 8.2.1 アプリケーションログ
```bash
# リアルタイムログの確認
tail -f logs/application-dev.log

# エラーログの確認
grep "ERROR" logs/application-dev.log

# 特定のクラスのログ確認
grep "com.ses.sales.support" logs/application-dev.log
```

#### 8.2.2 データベースログ
1. Supabaseダッシュボードで"Logs"を選択
2. "Database"タブでクエリログを確認
3. エラーがある場合は詳細を確認

## 9. 開発ワークフロー

### 9.1 ブランチ戦略
```bash
# 新機能開発
git checkout develop
git pull origin develop
git checkout -b feature/new-feature
git push origin feature/new-feature

# バグ修正
git checkout develop
git pull origin develop
git checkout -b bugfix/bug-description
git push origin bugfix/bug-description

# ホットフィックス
git checkout main
git pull origin main
git checkout -b hotfix/critical-fix
git push origin hotfix/critical-fix
```

### 9.2 コミットメッセージ規約
```
<type>(<scope>): <subject>

<body>

<footer>
```

例:
```
feat(auth): add JWT authentication

- Implement JWT token generation
- Add authentication filter
- Update security configuration

Closes #123
```

### 9.3 プルリクエスト作成
1. GitHubでプルリクエストを作成
2. テンプレートに従って記入
3. レビュアーを指定
4. ラベルを設定
5. マイルストーンを設定

## 10. 開発環境のメンテナンス

### 10.1 定期的な更新
```bash
# 依存関係の更新確認
mvn versions:display-dependency-updates

# プラグインの更新確認
mvn versions:display-plugin-updates

# 更新の実行
mvn versions:use-latest-versions
```

### 10.2 データベースのメンテナンス
1. Supabaseダッシュボードで"Settings" → "Database"
2. バックアップの確認
3. 接続プールの監視
4. クエリパフォーマンスの確認

### 10.3 開発環境のクリーンアップ
```bash
# Mavenキャッシュのクリア
mvn dependency:purge-local-repository

# ビルド成果物のクリア
mvn clean

# ログファイルのクリア
rm -rf logs/*.log

# IDEキャッシュのクリア（IntelliJ IDEA）
# File → Invalidate Caches and Restart
```

## 11. 次のステップ

### 11.1 開発開始
1. 要件定義書の確認
2. 設計書の確認
3. タスクの分解
4. 開発の開始

### 11.2 チーム開発
1. コードレビューの実施
2. ペアプログラミング
3. 知識共有
4. ドキュメント更新

### 11.3 継続的改善
1. 開発プロセスの改善
2. ツールの最適化
3. パフォーマンスの向上
4. セキュリティの強化
