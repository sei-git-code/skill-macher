# 運用マニュアル

## 1. 運用概要

### 1.1 運用体制

- **運用責任者**: システム管理者
- **監視担当**: 24 時間監視（自動化）
- **エスカレーション**: 重大障害時は開発チームに連絡
- **メンテナンス**: 月次メンテナンス（第 2 土曜日 2:00-4:00 JST）

### 1.2 運用スコープ

- **アプリケーション**: Spring Boot アプリケーション
- **データベース**: Supabase PostgreSQL
- **インフラ**: Oracle Cloud Infrastructure (OCI)
- **監視**: OCI Monitoring + カスタム監視

## 2. 監視・アラート

### 2.1 監視項目

#### 2.1.1 インフラ監視

```yaml
監視項目:
  CPU使用率:
    閾値: 80%
    アラート: WARNING
    重大度: 90%
    アラート: CRITICAL

  メモリ使用率:
    閾値: 85%
    アラート: WARNING
    重大度: 95%
    アラート: CRITICAL

  ディスク使用率:
    閾値: 80%
    アラート: WARNING
    重大度: 90%
    アラート: CRITICAL

  ネットワークI/O:
    閾値: 100MB/s
    アラート: WARNING
    重大度: 200MB/s
    アラート: CRITICAL
```

#### 2.1.2 アプリケーション監視

```yaml
監視項目:
  レスポンス時間:
    閾値: 2秒
    アラート: WARNING
    重大度: 5秒
    アラート: CRITICAL

  エラー率:
    閾値: 5%
    アラート: WARNING
    重大度: 10%
    アラート: CRITICAL

  スループット:
    閾値: 100 req/min
    アラート: WARNING
    重大度: 50 req/min
    アラート: CRITICAL

  ヘルスチェック:
    失敗: 即座にアラート
    重大度: CRITICAL
```

#### 2.1.3 データベース監視

```yaml
監視項目:
  接続数:
    閾値: 80%
    アラート: WARNING
    重大度: 95%
    アラート: CRITICAL

  クエリ実行時間:
    閾値: 5秒
    アラート: WARNING
    重大度: 10秒
    アラート: CRITICAL

  ディスク使用率:
    閾値: 80%
    アラート: WARNING
    重大度: 90%
    アラート: CRITICAL
```

### 2.2 アラート設定

#### 2.2.1 通知先設定

```yaml
通知先:
  Email:
    - admin@example.com
    - ops@example.com

  Slack:
    -  #infrastructure-alerts
    -  #critical-alerts

  SMS:
    - 重大障害時のみ
    - 緊急連絡先
```

#### 2.2.2 アラートレベル

```yaml
レベル:
  INFO:
    通知先: Email
    対応時間: 24時間以内

  WARNING:
    通知先: Email + Slack
    対応時間: 4時間以内

  CRITICAL:
    通知先: Email + Slack + SMS
    対応時間: 1時間以内
    エスカレーション: 開発チーム
```

## 3. ログ管理

### 3.1 ログの種類

#### 3.1.1 アプリケーションログ

```bash
# ログファイルの場所
/var/log/ses-sales-support/application-prod.log

# ログレベル
- ERROR: エラーログ
- WARN: 警告ログ
- INFO: 情報ログ
- DEBUG: デバッグログ（本番環境では無効）

# ログローテーション
- 最大ファイルサイズ: 500MB
- 保持期間: 30日
- 圧縮: 有効
```

#### 3.1.2 システムログ

```bash
# システムログの場所
/var/log/messages
/var/log/secure
/var/log/cron

# Dockerログ
docker-compose logs -f app
```

#### 3.1.3 アクセスログ

```bash
# Nginxアクセスログ
/var/log/nginx/access.log
/var/log/nginx/error.log

# ログフォーマット
# Combined Log Format
```

### 3.2 ログの確認方法

#### 3.2.1 リアルタイムログ確認

```bash
# アプリケーションログの監視
tail -f /var/log/ses-sales-support/application-prod.log

# エラーログの監視
tail -f /var/log/ses-sales-support/application-prod.log | grep ERROR

# 特定のユーザーのログ確認
grep "user-123" /var/log/ses-sales-support/application-prod.log
```

#### 3.2.2 ログ検索・分析

```bash
# エラー率の確認
grep -c "ERROR" /var/log/ses-sales-support/application-prod.log

# 時間範囲でのログ検索
grep "2024-01-15 10:" /var/log/ses-sales-support/application-prod.log

# 特定の処理のログ確認
grep "JobRequirementService" /var/log/ses-sales-support/application-prod.log
```

### 3.3 ログアーカイブ

#### 3.3.1 ログのアーカイブ

```bash
# 古いログの圧縮
gzip /var/log/ses-sales-support/application-prod.log.1

# ログのS3へのアップロード
aws s3 cp /var/log/ses-sales-support/application-prod.log.1.gz \
    s3://ses-sales-support-logs/$(date +%Y/%m)/

# ローカルログの削除
rm /var/log/ses-sales-support/application-prod.log.1.gz
```

## 4. パフォーマンス監視

### 4.1 メトリクス監視

#### 4.1.1 アプリケーションメトリクス

```bash
# メトリクスエンドポイント
curl https://ses-sales-support.example.com/actuator/metrics

# 主要メトリクス
- http.server.requests: HTTPリクエスト数
- jvm.memory.used: JVMメモリ使用量
- jvm.gc.pause: GC時間
- hikaricp.connections.active: データベース接続数
```

#### 4.1.2 データベースメトリクス

```sql
-- 接続数確認
SELECT count(*) FROM pg_stat_activity;

-- クエリ実行時間確認
SELECT query, mean_time, calls
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- ロック確認
SELECT * FROM pg_locks WHERE NOT granted;
```

### 4.2 パフォーマンスチューニング

#### 4.2.1 JVM チューニング

```bash
# JVMオプションの設定
JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"

# GCログの有効化
JAVA_OPTS="$JAVA_OPTS -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps"
```

#### 4.2.2 データベースチューニング

```sql
-- インデックスの確認
SELECT schemaname, tablename, indexname, indexdef
FROM pg_indexes
WHERE tablename IN ('users', 'job_requirements', 'employees');

-- クエリプランの確認
EXPLAIN ANALYZE SELECT * FROM job_requirements WHERE status = 'ACTIVE';
```

## 5. バックアップ・復旧

### 5.1 データベースバックアップ

#### 5.1.1 Supabase バックアップ

```yaml
バックアップ設定:
  自動バックアップ:
    頻度: 毎日 2:00 JST
    保持期間: 30日
    形式: SQLダンプ

  ポイントインタイム復旧:
    有効: はい
    保持期間: 7日
    復旧時間: 15分以内
```

#### 5.1.2 手動バックアップ

```bash
# データベースダンプの作成
pg_dump -h db.xxxxxxxxxxxx.supabase.co \
    -U postgres \
    -d postgres \
    -f backup_$(date +%Y%m%d_%H%M%S).sql

# バックアップの圧縮
gzip backup_$(date +%Y%m%d_%H%M%S).sql

# バックアップのS3へのアップロード
aws s3 cp backup_$(date +%Y%m%d_%H%M%S).sql.gz \
    s3://ses-sales-support-backups/database/
```

### 5.2 アプリケーション設定バックアップ

#### 5.2.1 設定ファイルバックアップ

```bash
# 設定ファイルのバックアップ
tar -czf config_backup_$(date +%Y%m%d_%H%M%S).tar.gz \
    /opt/ses-sales-support/.env \
    /opt/ses-sales-support/docker-compose.yml

# バックアップのS3へのアップロード
aws s3 cp config_backup_$(date +%Y%m%d_%H%M%S).tar.gz \
    s3://ses-sales-support-backups/config/
```

### 5.3 復旧手順

#### 5.3.1 データベース復旧

```bash
# バックアップからの復旧
psql -h db.xxxxxxxxxxxx.supabase.co \
    -U postgres \
    -d postgres \
    -f backup_20240115_020000.sql

# 復旧の確認
psql -h db.xxxxxxxxxxxx.supabase.co \
    -U postgres \
    -d postgres \
    -c "SELECT count(*) FROM users;"
```

#### 5.3.2 アプリケーション復旧

```bash
# 設定ファイルの復旧
tar -xzf config_backup_20240115_020000.tar.gz -C /

# アプリケーションの再起動
cd /opt/ses-sales-support
docker-compose down
docker-compose up -d

# 復旧の確認
curl -f https://ses-sales-support.example.com/actuator/health
```

## 6. セキュリティ管理

### 6.1 セキュリティ監視

#### 6.1.1 ログイン監視

```bash
# 失敗ログインの監視
grep "Authentication failed" /var/log/ses-sales-support/application-prod.log

# 異常なアクセスパターンの検出
grep "Suspicious activity" /var/log/ses-sales-support/application-prod.log
```

#### 6.1.2 アクセスログ監視

```bash
# 異常なIPアドレスからのアクセス
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr

# 404エラーの監視
grep " 404 " /var/log/nginx/access.log
```

### 6.2 脆弱性管理

#### 6.2.1 依存関係の脆弱性チェック

```bash
# Maven依存関係の脆弱性チェック
mvn org.owasp:dependency-check-maven:check

# Dockerイメージの脆弱性チェック
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
    aquasec/trivy image ses-sales-support-tool:latest
```

#### 6.2.2 セキュリティパッチの適用

```bash
# システムパッチの適用
yum update -y

# アプリケーション依存関係の更新
mvn versions:use-latest-versions

# セキュリティパッチの確認
yum list updates --security
```

## 7. 障害対応

### 7.1 障害レベル定義

#### 7.1.1 障害レベル

```yaml
レベル1 (Critical):
  影響: サービス完全停止
  対応時間: 15分以内
  エスカレーション: 即座

レベル2 (High):
  影響: 主要機能停止
  対応時間: 1時間以内
  エスカレーション: 30分以内

レベル3 (Medium):
  影響: 一部機能停止
  対応時間: 4時間以内
  エスカレーション: 2時間以内

レベル4 (Low):
  影響: 軽微な問題
  対応時間: 24時間以内
  エスカレーション: 12時間以内
```

### 7.2 障害対応手順

#### 7.2.1 初期対応

```bash
# 1. 障害の確認
curl -f https://ses-sales-support.example.com/actuator/health

# 2. ログの確認
tail -100 /var/log/ses-sales-support/application-prod.log

# 3. リソース使用状況の確認
top
df -h
free -h

# 4. ネットワーク接続の確認
ping google.com
telnet db.xxxxxxxxxxxx.supabase.co 5432
```

#### 7.2.2 応急処置

```bash
# アプリケーションの再起動
cd /opt/ses-sales-support
docker-compose restart app

# ロードバランサーからの一時的な除外
oci lb backend update \
    --load-balancer-id $LB_ID \
    --backend-set-name app-backend-set \
    --backend-name "10.0.2.10:8080" \
    --weight 0

# インスタンスの再起動
oci compute instance reboot --instance-id $INSTANCE_ID
```

### 7.3 障害報告書

#### 7.3.1 障害報告書テンプレート

```markdown
# 障害報告書

## 基本情報

- 障害発生日時: 2024-01-15 10:30 JST
- 障害レベル: Level 2 (High)
- 報告者: システム管理者
- 対応者: 開発チーム

## 障害内容

- 現象: アプリケーションの応答が遅い
- 影響範囲: 全ユーザー
- 影響度: 中

## 対応内容

- 10:35: アプリケーションの再起動
- 10:40: ログの確認
- 10:45: データベース接続の確認

## 原因分析

- 原因: データベース接続プールの枯渇
- 根本原因: 長時間実行クエリによる接続の占有

## 再発防止策

- クエリタイムアウトの設定
- 接続プールサイズの調整
- 監視アラートの追加
```

## 8. メンテナンス

### 8.1 定期メンテナンス

#### 8.1.1 月次メンテナンス

```bash
# メンテナンス日時: 毎月第2土曜日 2:00-4:00 JST

# 1. システム更新
yum update -y

# 2. ログローテーション
logrotate -f /etc/logrotate.d/ses-sales-support

# 3. ディスククリーンアップ
docker system prune -f

# 4. バックアップの確認
aws s3 ls s3://ses-sales-support-backups/

# 5. セキュリティスキャン
mvn org.owasp:dependency-check-maven:check
```

#### 8.1.2 四半期メンテナンス

```bash
# メンテナンス日時: 四半期ごと

# 1. データベースの最適化
psql -h db.xxxxxxxxxxxx.supabase.co -U postgres -d postgres -c "VACUUM ANALYZE;"

# 2. インデックスの再構築
psql -h db.xxxxxxxxxxxx.supabase.co -U postgres -d postgres -c "REINDEX DATABASE postgres;"

# 3. アプリケーションの更新
docker pull ghcr.io/your-org/ses-sales-support-tool:latest
docker-compose down
docker-compose up -d

# 4. パフォーマンステスト
ab -n 1000 -c 10 https://ses-sales-support.example.com/
```

### 8.2 緊急メンテナンス

#### 8.2.1 緊急メンテナンス手順

```bash
# 1. メンテナンスモードの有効化
echo "MAINTENANCE_MODE=true" >> /opt/ses-sales-support/.env

# 2. アプリケーションの再起動
docker-compose restart app

# 3. メンテナンスモードの無効化
sed -i 's/MAINTENANCE_MODE=true/MAINTENANCE_MODE=false/' /opt/ses-sales-support/.env

# 4. アプリケーションの再起動
docker-compose restart app
```

## 9. 容量管理

### 9.1 リソース監視

#### 9.1.1 容量計画

```yaml
現在の容量:
  CPU: 1 vCPU (使用率: 60%)
  メモリ: 1 GB (使用率: 70%)
  ディスク: 50 GB (使用率: 40%)
  ネットワーク: 100 Mbps (使用率: 30%)

拡張計画:
  CPU: 2 vCPU (使用率: 80%時)
  メモリ: 2 GB (使用率: 85%時)
  ディスク: 100 GB (使用率: 80%時)
```

#### 9.1.2 自動スケーリング

```bash
# 自動スケーリングの設定
oci compute instance-pool create \
    --compartment-id $COMPARTMENT_ID \
    --display-name "ses-sales-support-pool" \
    --instance-configuration-id $INSTANCE_CONFIG_ID \
    --size 2 \
    --placement-configurations '[{"availability-domain":"AD-1","primary-subnet-id":"'$SUBNET_ID'"}]'

# スケーリングポリシーの設定
oci compute auto-scaling-configuration create \
    --compartment-id $COMPARTMENT_ID \
    --display-name "ses-sales-support-autoscaling" \
    --resource-type "instance-pool" \
    --resource-id $INSTANCE_POOL_ID \
    --policies '[{"display-name":"scale-out","execution-schedule":{"type":"cron","timezone":"UTC","expression":"0 */5 * * * *"},"resource-action":{"action":"CHANGE_COUNT","resource-id":"'$INSTANCE_POOL_ID'","action-type":"POWER_ACTION"},"capacity":{"initial":2,"min":1,"max":5},"execution-schedule":{"type":"cron","timezone":"UTC","expression":"0 */5 * * * *"}}]'
```

## 10. ドキュメント管理

### 10.1 運用ドキュメント

#### 10.1.1 ドキュメント一覧

```yaml
運用ドキュメント:
  - 運用マニュアル（本ドキュメント）
  - 障害対応手順書
  - バックアップ・復旧手順書
  - セキュリティ管理手順書
  - メンテナンス手順書
  - 監視・アラート設定書
```

#### 10.1.2 ドキュメント更新

```bash
# ドキュメントの更新
git checkout main
git pull origin main
git checkout -b docs/update-operation-manual
# ドキュメントを更新
git add .
git commit -m "docs: update operation manual"
git push origin docs/update-operation-manual
# プルリクエストを作成
```

### 10.2 ナレッジベース

#### 10.2.1 よくある問題と解決方法

```markdown
# よくある問題と解決方法

## Q: アプリケーションが起動しない

A:

1. ログの確認: docker-compose logs app
2. 環境変数の確認: docker-compose config
3. データベース接続の確認: telnet db.xxx.supabase.co 5432

## Q: レスポンスが遅い

A:

1. リソース使用状況の確認: top, free, df
2. データベースクエリの確認: pg_stat_statements
3. ネットワーク接続の確認: ping, traceroute

## Q: エラーが頻発する

A:

1. エラーログの確認: grep ERROR /var/log/ses-sales-support/application-prod.log
2. データベース接続の確認: SELECT count(\*) FROM pg_stat_activity;
3. アプリケーションの再起動: docker-compose restart app
```

## 11. 連絡先・エスカレーション

### 11.1 連絡先一覧

#### 11.1.1 内部連絡先

```yaml
開発チーム:
  リーダー: dev-lead@example.com
  メンバー: dev-team@example.com

インフラチーム:
  リーダー: infra-lead@example.com
  メンバー: infra-team@example.com

セキュリティチーム:
  リーダー: security-lead@example.com
  メンバー: security-team@example.com
```

#### 11.1.2 外部連絡先

```yaml
Supabase:
  サポート: support@supabase.com
  緊急時: emergency@supabase.com

Oracle Cloud:
  サポート: support@oracle.com
  緊急時: emergency@oracle.com

ドメイン管理:
  プロバイダー: domain@example.com
  緊急時: emergency@example.com
```

### 11.2 エスカレーション手順

#### 11.2.1 エスカレーションフロー

```yaml
Level 1 (Critical): 1. システム管理者が対応
  2. 15分以内に解決しない場合は開発チームにエスカレーション
  3. 30分以内に解決しない場合は経営陣に報告

Level 2 (High): 1. システム管理者が対応
  2. 1時間以内に解決しない場合は開発チームにエスカレーション
  3. 2時間以内に解決しない場合は経営陣に報告

Level 3 (Medium): 1. システム管理者が対応
  2. 4時間以内に解決しない場合は開発チームにエスカレーション

Level 4 (Low): 1. システム管理者が対応
  2. 24時間以内に解決しない場合は開発チームにエスカレーション
```

## 12. 運用改善

### 12.1 運用指標

#### 12.1.1 KPI

```yaml
可用性:
  目標: 99.9%
  現在: 99.95%

レスポンス時間:
  目標: 2秒以内
  現在: 1.5秒

エラー率:
  目標: 1%以下
  現在: 0.5%

MTTR (平均復旧時間):
  目標: 1時間以内
  現在: 45分
```

#### 12.1.2 改善活動

```bash
# 月次運用レビュー
- 障害の分析
- パフォーマンスの評価
- 改善点の特定
- アクションプランの策定

# 四半期運用改善
- プロセスの見直し
- ツールの最適化
- 自動化の推進
- ドキュメントの更新
```

### 12.2 自動化推進

#### 12.2.1 自動化対象

```yaml
監視:
  - ヘルスチェック
  - リソース監視
  - ログ監視

バックアップ:
  - データベースバックアップ
  - 設定ファイルバックアップ
  - ログアーカイブ

デプロイ:
  - アプリケーションデプロイ
  - 設定変更
  - ロールバック
```

#### 12.2.2 自動化ツール

```bash
# Ansible による自動化
ansible-playbook -i inventory/prod deploy.yml

# Terraform によるインフラ管理
terraform plan
terraform apply

# GitHub Actions によるCI/CD
# .github/workflows/deploy.yml
```

## 13. 災害復旧

### 13.1 災害復旧計画

#### 13.1.1 復旧時間目標

```yaml
RTO (Recovery Time Objective):
  目標: 4時間以内
  現実的: 2時間以内

RPO (Recovery Point Objective):
  目標: 1時間以内
  現実的: 30分以内
```

#### 13.1.2 復旧手順

```bash
# 1. 災害の確認
- 影響範囲の特定
- 復旧優先度の決定
- 復旧チームの招集

# 2. 緊急対応
- サービス停止の通知
- 代替手段の提供
- 復旧作業の開始

# 3. 復旧作業
- データベースの復旧
- アプリケーションの復旧
- インフラの復旧

# 4. 検証・復旧
- 機能テストの実行
- パフォーマンステストの実行
- サービス再開の通知
```

### 13.2 バックアップ戦略

#### 13.2.1 バックアップ頻度

```yaml
データベース:
  頻度: 毎日
  保持期間: 30日
  場所: Supabase + S3

アプリケーション:
  頻度: 毎週
  保持期間: 12週
  場所: S3

設定ファイル:
  頻度: 毎日
  保持期間: 90日
  場所: S3
```

## 14. コンプライアンス

### 14.1 セキュリティコンプライアンス

#### 14.1.1 セキュリティ要件

```yaml
認証・認可:
  - 多要素認証の実装
  - パスワードポリシーの適用
  - セッション管理の強化

データ保護:
  - 暗号化の実装
  - アクセス制御の強化
  - 監査ログの記録

脆弱性管理:
  - 定期的な脆弱性スキャン
  - セキュリティパッチの適用
  - セキュリティテストの実施
```

#### 14.1.2 監査対応

```bash
# 監査ログの確認
grep "AUDIT" /var/log/ses-sales-support/application-prod.log

# アクセスログの確認
grep "LOGIN" /var/log/ses-sales-support/application-prod.log

# セキュリティイベントの確認
grep "SECURITY" /var/log/ses-sales-support/application-prod.log
```

### 14.2 データ保護

#### 14.2.1 個人情報保護

```yaml
データの分類:
  - 個人情報: 暗号化必須
  - 機密情報: アクセス制御必須
  - 一般情報: 通常の保護

データの保持:
  - 個人情報: 3年
  - ログデータ: 1年
  - バックアップ: 30日
```

#### 14.2.2 データ削除

```bash
# 個人情報の削除
psql -h db.xxxxxxxxxxxx.supabase.co -U postgres -d postgres -c "
DELETE FROM users WHERE id = 'user-123';
DELETE FROM user_profiles WHERE user_id = 'user-123';
"

# ログの削除
find /var/log/ses-sales-support/ -name "*.log" -mtime +365 -delete
```

## 15. 運用終了

### 15.1 サービス終了手順

#### 15.1.1 終了計画

```yaml
通知期間:
  - ユーザー通知: 3ヶ月前
  - データエクスポート: 1ヶ月前
  - サービス停止: 予定日

データ移行:
  - データのエクスポート
  - バックアップの作成
  - 移行先への転送
```

#### 15.1.2 終了作業

```bash
# 1. データのエクスポート
pg_dump -h db.xxxxxxxxxxxx.supabase.co \
    -U postgres \
    -d postgres \
    -f final_backup_$(date +%Y%m%d).sql

# 2. リソースの削除
oci compute instance terminate --instance-id $INSTANCE_ID
oci lb load-balancer delete --load-balancer-id $LB_ID

# 3. データの削除
# Supabaseプロジェクトの削除
# S3バケットの削除
# ドメインの削除
```

### 15.2 アーカイブ

#### 15.2.1 アーカイブ対象

```yaml
データ:
  - データベースダンプ
  - ログファイル
  - 設定ファイル

ドキュメント:
  - 設計書
  - 運用マニュアル
  - 障害報告書

コード:
  - ソースコード
  - 設定ファイル
  - スクリプト
```

#### 15.2.2 アーカイブ手順

```bash
# アーカイブの作成
tar -czf ses-sales-support-archive-$(date +%Y%m%d).tar.gz \
    /opt/ses-sales-support/ \
    /var/log/ses-sales-support/ \
    /etc/nginx/ \
    /etc/systemd/system/

# アーカイブの保存
aws s3 cp ses-sales-support-archive-$(date +%Y%m%d).tar.gz \
    s3://ses-sales-support-archive/
```
