# デプロイ手順書

## 1. デプロイ概要

### 1.1 デプロイ戦略
- **Blue-Green Deployment**: ゼロダウンタイムデプロイ
- **CI/CD Pipeline**: GitHub Actions による自動化
- **環境分離**: dev, staging, prod 環境の分離
- **ロールバック**: 迅速なロールバック機能

### 1.2 デプロイフロー
```
┌─────────────────────────────────────────────────────────┐
│                    GitHub Repository                     │
│                         │                                │
│                         ▼                                │
│              GitHub Actions Pipeline                     │
│                         │                                │
│                         ▼                                │
│              Build & Test & Package                     │
│                         │                                │
│                         ▼                                │
│              Deploy to OCI Instances                    │
│                         │                                │
│                         ▼                                │
│              Health Check & Switch                      │
│                         │                                │
│                         ▼                                │
│              Update Load Balancer                       │
└─────────────────────────────────────────────────────────┘
```

## 2. 前提条件

### 2.1 必要なアカウント・サービス
- **GitHub**: ソースコード管理
- **Oracle Cloud Infrastructure (OCI)**: インフラストラクチャ
- **Supabase**: データベースサービス
- **Docker Hub**: コンテナイメージ管理

### 2.2 必要なツール
- **OCI CLI**: Oracle Cloud コマンドラインツール
- **Docker**: コンテナ化
- **Maven**: ビルドツール
- **Git**: バージョン管理

## 3. OCI環境構築

### 3.1 OCI CLI インストール

#### 3.1.1 macOS
```bash
# Homebrewを使用してインストール
brew install oci-cli

# インストール確認
oci --version
```

#### 3.1.2 Linux
```bash
# インストールスクリプトの実行
bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)"

# インストール確認
oci --version
```

#### 3.1.3 Windows
```powershell
# Chocolateyを使用してインストール
choco install oci-cli

# インストール確認
oci --version
```

### 3.2 OCI設定

#### 3.2.1 認証設定
```bash
# OCI設定の初期化
oci setup config

# 設定ファイルの場所
# ~/.oci/config

# 設定内容の例
[DEFAULT]
user=ocid1.user.oc1..aaaaaaaa...
fingerprint=xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx
key_file=~/.oci/oci_api_key.pem
tenancy=ocid1.tenancy.oc1..aaaaaaaa...
region=ap-tokyo-1
```

#### 3.2.2 API キーの生成
1. OCIコンソールで"Identity" → "Users"を選択
2. 対象ユーザーを選択
3. "API Keys" → "Add API Key"をクリック
4. "Generate API Key Pair"を選択
5. 生成された秘密鍵をダウンロード
6. 公開鍵をOCIに登録

### 3.3 コンパートメント作成
```bash
# コンパートメントの作成
oci iam compartment create \
    --compartment-id ocid1.tenancy.oc1..aaaaaaaa... \
    --name "SES-Sales-Support-Compartment" \
    --description "SES営業支援ツール用コンパートメント"

# コンパートメントIDの取得
COMPARTMENT_ID=$(oci iam compartment list \
    --compartment-id-in-subtree true \
    --query 'data[?name=="SES-Sales-Support-Compartment"].id' \
    --raw-output)
```

### 3.4 VCN作成
```bash
# VCNの作成
oci network vcn create \
    --compartment-id $COMPARTMENT_ID \
    --cidr-block "10.0.0.0/16" \
    --display-name "ses-sales-support-vcn" \
    --dns-label "sessales"

# VCN IDの取得
VCN_ID=$(oci network vcn list \
    --compartment-id $COMPARTMENT_ID \
    --query 'data[?display-name=="ses-sales-support-vcn"].id' \
    --raw-output)
```

### 3.5 サブネット作成
```bash
# パブリックサブネットの作成
oci network subnet create \
    --compartment-id $COMPARTMENT_ID \
    --vcn-id $VCN_ID \
    --cidr-block "10.0.1.0/24" \
    --display-name "public-subnet" \
    --dns-label "public"

# プライベートサブネットの作成
oci network subnet create \
    --compartment-id $COMPARTMENT_ID \
    --vcn-id $VCN_ID \
    --cidr-block "10.0.2.0/24" \
    --display-name "private-subnet" \
    --dns-label "private"
```

### 3.6 セキュリティリスト作成
```bash
# ロードバランサー用セキュリティリスト
oci network security-list create \
    --compartment-id $COMPARTMENT_ID \
    --vcn-id $VCN_ID \
    --display-name "lb-security-list" \
    --egress-security-rules '[{"destination":"10.0.2.0/24","protocol":"6","isStateless":false}]' \
    --ingress-security-rules '[{"source":"0.0.0.0/0","protocol":"6","isStateless":false,"tcpOptions":{"destinationPortRange":{"max":443,"min":443}}},{"source":"0.0.0.0/0","protocol":"6","isStateless":false,"tcpOptions":{"destinationPortRange":{"max":80,"min":80}}}]'

# アプリケーション用セキュリティリスト
oci network security-list create \
    --compartment-id $COMPARTMENT_ID \
    --vcn-id $VCN_ID \
    --display-name "app-security-list" \
    --egress-security-rules '[{"destination":"0.0.0.0/0","protocol":"6","isStateless":false,"tcpOptions":{"destinationPortRange":{"max":443,"min":443}}},{"destination":"0.0.0.0/0","protocol":"6","isStateless":false,"tcpOptions":{"destinationPortRange":{"max":80,"min":80}}}]' \
    --ingress-security-rules '[{"source":"10.0.1.0/24","protocol":"6","isStateless":false,"tcpOptions":{"destinationPortRange":{"max":8080,"min":8080}}},{"source":"10.0.1.0/24","protocol":"6","isStateless":false,"tcpOptions":{"destinationPortRange":{"max":22,"min":22}}}]'
```

## 4. Docker設定

### 4.1 Dockerfile作成
```dockerfile
# Dockerfile
FROM openjdk:17-jdk-slim

# 作業ディレクトリの設定
WORKDIR /app

# アプリケーションファイルのコピー
COPY target/ses-sales-support-tool-1.0.0.jar app.jar

# ポートの公開
EXPOSE 8080

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health || exit 1

# アプリケーションの起動
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 4.2 Docker Compose設定
```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SUPABASE_DATABASE_URL=${SUPABASE_DATABASE_URL}
      - SUPABASE_DATABASE_USERNAME=${SUPABASE_DATABASE_USERNAME}
      - SUPABASE_DATABASE_PASSWORD=${SUPABASE_DATABASE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres
    restart: unless-stopped

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=ses_sales_support
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  postgres_data:
```

### 4.3 Dockerイメージのビルド
```bash
# イメージのビルド
docker build -t ses-sales-support-tool:latest .

# イメージの確認
docker images

# ローカルでのテスト実行
docker run -p 8080:8080 \
    -e SPRING_PROFILES_ACTIVE=prod \
    -e SUPABASE_DATABASE_URL=$SUPABASE_DATABASE_URL \
    -e SUPABASE_DATABASE_USERNAME=$SUPABASE_DATABASE_USERNAME \
    -e SUPABASE_DATABASE_PASSWORD=$SUPABASE_DATABASE_PASSWORD \
    -e JWT_SECRET=$JWT_SECRET \
    ses-sales-support-tool:latest
```

## 5. CI/CD Pipeline設定

### 5.1 GitHub Actions設定

#### 5.1.1 ワークフローファイル (.github/workflows/deploy.yml)
```yaml
name: Deploy to OCI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Run tests
      run: mvn clean test
    
    - name: Generate coverage report
      run: mvn jacoco:report
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: target/site/jacoco/jacoco.xml

  build:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Build application
      run: mvn clean package -DskipTests
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure OCI CLI
      uses: oracle-actions/configure-oci-cli@v1
      with:
        config-file-content: ${{ secrets.OCI_CONFIG }}
        api-key: ${{ secrets.OCI_API_KEY }}
        fingerprint: ${{ secrets.OCI_FINGERPRINT }}
        passphrase: ${{ secrets.OCI_PASSPHRASE }}
        region: ${{ secrets.OCI_REGION }}
        tenancy: ${{ secrets.OCI_TENANCY }}
        user-id: ${{ secrets.OCI_USER_ID }}
    
    - name: Deploy to staging
      run: |
        # ステージング環境へのデプロイ
        oci compute instance list \
          --compartment-id ${{ secrets.OCI_COMPARTMENT_ID }} \
          --query 'data[?display-name=="ses-sales-support-staging"]'
        
        # アプリケーションの更新
        # (実際のデプロイスクリプトを実行)

  deploy-production:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure OCI CLI
      uses: oracle-actions/configure-oci-cli@v1
      with:
        config-file-content: ${{ secrets.OCI_CONFIG }}
        api-key: ${{ secrets.OCI_API_KEY }}
        fingerprint: ${{ secrets.OCI_FINGERPRINT }}
        passphrase: ${{ secrets.OCI_PASSPHRASE }}
        region: ${{ secrets.OCI_REGION }}
        tenancy: ${{ secrets.OCI_TENANCY }}
        user-id: ${{ secrets.OCI_USER_ID }}
    
    - name: Deploy to production
      run: |
        # 本番環境へのデプロイ
        oci compute instance list \
          --compartment-id ${{ secrets.OCI_COMPARTMENT_ID }} \
          --query 'data[?display-name=="ses-sales-support-prod"]'
        
        # アプリケーションの更新
        # (実際のデプロイスクリプトを実行)
```

#### 5.1.2 GitHub Secrets設定
```bash
# GitHubリポジトリのSecretsに以下を設定
OCI_CONFIG=<OCI設定ファイルの内容>
OCI_API_KEY=<API秘密鍵の内容>
OCI_FINGERPRINT=<API鍵のフィンガープリント>
OCI_PASSPHRASE=<API鍵のパスフレーズ>
OCI_REGION=ap-tokyo-1
OCI_TENANCY=<テナンシーOCID>
OCI_USER_ID=<ユーザーOCID>
OCI_COMPARTMENT_ID=<コンパートメントOCID>
SUPABASE_DATABASE_URL=<SupabaseデータベースURL>
SUPABASE_DATABASE_USERNAME=<Supabaseユーザー名>
SUPABASE_DATABASE_PASSWORD=<Supabaseパスワード>
JWT_SECRET=<JWT秘密鍵>
```

## 6. インスタンス作成・設定

### 6.1 インスタンス作成
```bash
# インスタンスの作成
oci compute instance launch \
    --compartment-id $COMPARTMENT_ID \
    --availability-domain "AD-1" \
    --display-name "ses-sales-support-prod-1" \
    --image-id "ocid1.image.oc1.ap-tokyo-1.aaaaaaaa..." \
    --shape "VM.Standard.E2.1.Micro" \
    --subnet-id $SUBNET_ID \
    --assign-public-ip true \
    --ssh-authorized-keys-file ~/.ssh/id_rsa.pub \
    --user-data-file user-data.sh
```

### 6.2 ユーザーデータスクリプト (user-data.sh)
```bash
#!/bin/bash

# システムの更新
yum update -y

# Java 17のインストール
yum install -y java-17-openjdk java-17-openjdk-devel

# Dockerのインストール
yum install -y docker
systemctl start docker
systemctl enable docker

# Docker Composeのインストール
curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# アプリケーションディレクトリの作成
mkdir -p /opt/ses-sales-support
cd /opt/ses-sales-support

# 環境変数の設定
cat > .env << EOF
SPRING_PROFILES_ACTIVE=prod
SUPABASE_DATABASE_URL=${SUPABASE_DATABASE_URL}
SUPABASE_DATABASE_USERNAME=${SUPABASE_DATABASE_USERNAME}
SUPABASE_DATABASE_PASSWORD=${SUPABASE_DATABASE_PASSWORD}
JWT_SECRET=${JWT_SECRET}
EOF

# Docker Composeファイルの作成
cat > docker-compose.yml << EOF
version: '3.8'

services:
  app:
    image: ghcr.io/your-org/ses-sales-support-tool:latest
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SUPABASE_DATABASE_URL=\${SUPABASE_DATABASE_URL}
      - SUPABASE_DATABASE_USERNAME=\${SUPABASE_DATABASE_USERNAME}
      - SUPABASE_DATABASE_PASSWORD=\${SUPABASE_DATABASE_PASSWORD}
      - JWT_SECRET=\${JWT_SECRET}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
EOF

# アプリケーションの起動
docker-compose up -d

# ログの確認
docker-compose logs -f
```

### 6.3 ロードバランサー作成
```bash
# ロードバランサーの作成
oci lb load-balancer create \
    --compartment-id $COMPARTMENT_ID \
    --display-name "ses-sales-support-lb" \
    --shape-name "flexible" \
    --subnet-ids '["'$PUBLIC_SUBNET_ID'"]' \
    --is-private false \
    --minimum-bandwidth-in-mbps 10 \
    --maximum-bandwidth-in-mbps 100

# ロードバランサーIDの取得
LB_ID=$(oci lb load-balancer list \
    --compartment-id $COMPARTMENT_ID \
    --query 'data[?display-name=="ses-sales-support-lb"].id' \
    --raw-output)

# バックエンドセットの作成
oci lb backend-set create \
    --load-balancer-id $LB_ID \
    --name "app-backend-set" \
    --policy "ROUND_ROBIN" \
    --health-checker-protocol "HTTP" \
    --health-checker-port 8080 \
    --health-checker-url-path "/actuator/health" \
    --health-checker-interval-in-ms 30000 \
    --health-checker-timeout-in-ms 5000 \
    --health-checker-retries 3

# バックエンドの追加
oci lb backend create \
    --load-balancer-id $LB_ID \
    --backend-set-name "app-backend-set" \
    --ip-address "10.0.2.10" \
    --port 8080 \
    --weight 1

# リスナーの作成
oci lb listener create \
    --load-balancer-id $LB_ID \
    --name "app-listener" \
    --default-backend-set-name "app-backend-set" \
    --port 443 \
    --protocol "HTTP" \
    --ssl-certificate-name "app-cert"
```

## 7. ドメイン・SSL設定

### 7.1 ドメイン設定
```bash
# DNSレコードの設定（例：Cloudflare）
# Aレコード: ses-sales-support.example.com → ロードバランサーIP
# CNAMEレコード: www.ses-sales-support.example.com → ses-sales-support.example.com
```

### 7.2 SSL証明書設定
```bash
# Let's Encrypt証明書の取得
certbot certonly --manual \
    --preferred-challenges dns \
    --email admin@example.com \
    --agree-tos \
    --no-eff-email \
    -d ses-sales-support.example.com \
    -d www.ses-sales-support.example.com

# 証明書のOCIへのアップロード
oci lb certificate create \
    --load-balancer-id $LB_ID \
    --certificate-name "app-cert" \
    --private-key-file /etc/letsencrypt/live/ses-sales-support.example.com/privkey.pem \
    --public-certificate-file /etc/letsencrypt/live/ses-sales-support.example.com/fullchain.pem
```

## 8. デプロイスクリプト

### 8.1 デプロイスクリプト (deploy.sh)
```bash
#!/bin/bash

set -e

# 環境変数の設定
ENVIRONMENT=${1:-staging}
VERSION=${2:-latest}
REGISTRY="ghcr.io/your-org/ses-sales-support-tool"

# インスタンスの取得
INSTANCE_ID=$(oci compute instance list \
    --compartment-id $OCI_COMPARTMENT_ID \
    --query "data[?display-name==\"ses-sales-support-${ENVIRONMENT}\"].id" \
    --raw-output)

# インスタンスのIP取得
INSTANCE_IP=$(oci compute instance list-vnics \
    --instance-id $INSTANCE_ID \
    --query "data[0].public-ip" \
    --raw-output)

# アプリケーションの更新
ssh -o StrictHostKeyChecking=no opc@$INSTANCE_IP << EOF
    cd /opt/ses-sales-support
    
    # 新しいイメージの取得
    docker pull $REGISTRY:$VERSION
    
    # アプリケーションの停止
    docker-compose down
    
    # 新しいイメージで起動
    docker-compose up -d
    
    # ヘルスチェック
    sleep 30
    curl -f http://localhost:8080/actuator/health
EOF

echo "Deployment completed successfully!"
```

### 8.2 ロールバックスクリプト (rollback.sh)
```bash
#!/bin/bash

set -e

# 環境変数の設定
ENVIRONMENT=${1:-staging}
PREVIOUS_VERSION=${2:-previous}

# インスタンスの取得
INSTANCE_ID=$(oci compute instance list \
    --compartment-id $OCI_COMPARTMENT_ID \
    --query "data[?display-name==\"ses-sales-support-${ENVIRONMENT}\"].id" \
    --raw-output)

# インスタンスのIP取得
INSTANCE_IP=$(oci compute instance list-vnics \
    --instance-id $INSTANCE_ID \
    --query "data[0].public-ip" \
    --raw-output)

# ロールバックの実行
ssh -o StrictHostKeyChecking=no opc@$INSTANCE_IP << EOF
    cd /opt/ses-sales-support
    
    # 前のバージョンに戻す
    docker-compose down
    docker-compose up -d
    
    # ヘルスチェック
    sleep 30
    curl -f http://localhost:8080/actuator/health
EOF

echo "Rollback completed successfully!"
```

## 9. 監視・ログ設定

### 9.1 監視設定
```bash
# アラームの作成
oci monitoring alarm create \
    --compartment-id $COMPARTMENT_ID \
    --destinations '["'$NOTIFICATION_TOPIC_ID'"]' \
    --display-name "High CPU Usage" \
    --metric-compartment-id $COMPARTMENT_ID \
    --namespace "oci_computeagent" \
    --query-text "CpuUtilization[1m]{resourceId = \"'$INSTANCE_ID'\"}.mean() > 80" \
    --severity "WARNING" \
    --body "CPU usage is above 80%" \
    --is-enabled true
```

### 9.2 ログ設定
```bash
# ロググループの作成
oci log log-group create \
    --compartment-id $COMPARTMENT_ID \
    --display-name "ses-sales-support-logs" \
    --description "Application logs for SES Sales Support Tool"

# ログの作成
oci log log create \
    --log-group-id $LOG_GROUP_ID \
    --display-name "application-logs" \
    --log-type "CUSTOM" \
    --configuration-source-type "OCID"
```

## 10. デプロイ手順

### 10.1 初回デプロイ
```bash
# 1. インフラストラクチャの作成
./scripts/create-infrastructure.sh

# 2. アプリケーションのビルド
mvn clean package -DskipTests

# 3. Dockerイメージのビルド
docker build -t ses-sales-support-tool:latest .

# 4. イメージのプッシュ
docker push ghcr.io/your-org/ses-sales-support-tool:latest

# 5. インスタンスへのデプロイ
./scripts/deploy.sh production latest
```

### 10.2 通常のデプロイ
```bash
# 1. コードのプッシュ
git push origin main

# 2. GitHub Actionsが自動実行
# - テスト実行
# - ビルド
# - デプロイ

# 3. デプロイ状況の確認
./scripts/check-deployment.sh production
```

### 10.3 ロールバック
```bash
# 1. 前のバージョンの確認
./scripts/list-versions.sh

# 2. ロールバックの実行
./scripts/rollback.sh production previous

# 3. ロールバック状況の確認
./scripts/check-deployment.sh production
```

## 11. デプロイ後の確認

### 11.1 ヘルスチェック
```bash
# アプリケーションのヘルスチェック
curl -f https://ses-sales-support.example.com/actuator/health

# データベース接続の確認
curl -f https://ses-sales-support.example.com/actuator/health/db

# メトリクスの確認
curl -f https://ses-sales-support.example.com/actuator/metrics
```

### 11.2 ログの確認
```bash
# アプリケーションログの確認
ssh opc@$INSTANCE_IP "docker-compose logs -f app"

# システムログの確認
ssh opc@$INSTANCE_IP "journalctl -u docker -f"
```

### 11.3 パフォーマンステスト
```bash
# 負荷テストの実行
ab -n 1000 -c 10 https://ses-sales-support.example.com/

# レスポンス時間の確認
curl -w "@curl-format.txt" -o /dev/null -s https://ses-sales-support.example.com/
```

## 12. トラブルシューティング

### 12.1 よくある問題

#### 12.1.1 デプロイ失敗
```bash
# ログの確認
ssh opc@$INSTANCE_IP "docker-compose logs app"

# インスタンスの状態確認
oci compute instance get --instance-id $INSTANCE_ID

# ネットワーク接続の確認
ssh opc@$INSTANCE_IP "ping google.com"
```

#### 12.1.2 アプリケーション起動失敗
```bash
# コンテナの状態確認
ssh opc@$INSTANCE_IP "docker ps -a"

# 環境変数の確認
ssh opc@$INSTANCE_IP "docker-compose config"

# データベース接続の確認
ssh opc@$INSTANCE_IP "docker exec -it app curl localhost:8080/actuator/health"
```

#### 12.1.3 ロードバランサー問題
```bash
# ロードバランサーの状態確認
oci lb load-balancer get --load-balancer-id $LB_ID

# バックエンドの状態確認
oci lb backend list --load-balancer-id $LB_ID --backend-set-name app-backend-set

# ヘルスチェックの確認
oci lb backend get \
    --load-balancer-id $LB_ID \
    --backend-set-name app-backend-set \
    --backend-name "10.0.2.10:8080"
```

### 12.2 緊急時の対応

#### 12.2.1 緊急ロールバック
```bash
# 即座にロールバック
./scripts/emergency-rollback.sh production

# サービス停止
ssh opc@$INSTANCE_IP "docker-compose down"

# 前のバージョンで再起動
ssh opc@$INSTANCE_IP "docker-compose up -d"
```

#### 12.2.2 インスタンス再起動
```bash
# インスタンスの再起動
oci compute instance reboot --instance-id $INSTANCE_ID

# 再起動後の確認
sleep 60
curl -f https://ses-sales-support.example.com/actuator/health
```

## 13. セキュリティ設定

### 13.1 ファイアウォール設定
```bash
# セキュリティリストの更新
oci network security-list update \
    --security-list-id $SECURITY_LIST_ID \
    --ingress-security-rules '[
        {
            "source": "0.0.0.0/0",
            "protocol": "6",
            "isStateless": false,
            "tcpOptions": {
                "destinationPortRange": {
                    "max": 443,
                    "min": 443
                }
            }
        }
    ]'
```

### 13.2 SSL/TLS設定
```bash
# SSL証明書の更新
oci lb certificate update \
    --load-balancer-id $LB_ID \
    --certificate-name app-cert \
    --private-key-file /etc/letsencrypt/live/ses-sales-support.example.com/privkey.pem \
    --public-certificate-file /etc/letsencrypt/live/ses-sales-support.example.com/fullchain.pem
```

## 14. バックアップ・復旧

### 14.1 データベースバックアップ
```bash
# Supabaseダッシュボードでバックアップ設定
# - 自動バックアップ: 毎日
# - 保持期間: 30日
# - ポイントインタイム復旧: 有効
```

### 14.2 アプリケーション設定バックアップ
```bash
# 設定ファイルのバックアップ
ssh opc@$INSTANCE_IP "tar -czf /tmp/app-config-backup.tar.gz /opt/ses-sales-support"

# バックアップのダウンロード
scp opc@$INSTANCE_IP:/tmp/app-config-backup.tar.gz ./backups/
```

## 15. 継続的改善

### 15.1 デプロイパイプラインの最適化
- デプロイ時間の短縮
- テスト実行時間の最適化
- ロールバック時間の短縮

### 15.2 監視の強化
- アラートの最適化
- ダッシュボードの改善
- ログ分析の自動化

### 15.3 セキュリティの強化
- 脆弱性スキャンの自動化
- セキュリティパッチの自動適用
- アクセス制御の強化
