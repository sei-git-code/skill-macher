# アプリケーション設計書

## 1. アプリケーション概要

### 1.1 アプリケーション名

SES 営業支援ツール

### 1.2 アーキテクチャパターン

- **アーキテクチャ**: MVC (Model-View-Controller) パターン
- **フレームワーク**: Spring Boot 3.x
- **テンプレートエンジン**: Thymeleaf
- **データベース**: Supabase PostgreSQL
- **認証・認可**: Spring Security

### 1.3 技術スタック

```yaml
Spring Boot: 3.2.0
Java: 17
Thymeleaf: 3.1.1
Spring Security: 6.2.0
Spring Data JPA: 3.2.0
PostgreSQL Driver: 42.7.1
Bootstrap: 5.3.2
```

## 2. パッケージ構成

### 2.1 パッケージ構造

```
com.ses.sales.support
├── SesSalesSupportApplication.java          # メインアプリケーションクラス
├── config/                                  # 設定クラス
│   ├── SecurityConfig.java                 # Spring Security設定
│   ├── DatabaseConfig.java                 # データベース設定
│   ├── ThymeleafConfig.java                # Thymeleaf設定
│   └── WebConfig.java                      # Web設定
├── controller/                             # コントローラー層
│   ├── AuthController.java                 # 認証コントローラー
│   ├── DashboardController.java            # ダッシュボードコントローラー
│   ├── JobRequirementController.java       # 人員募集要項コントローラー
│   ├── EmployeeController.java             # SES人員コントローラー
│   ├── MatchingController.java             # スキルマッチングコントローラー
│   ├── ReportController.java               # レポートコントローラー
│   └── UserController.java                 # ユーザー管理コントローラー
├── service/                                 # サービス層
│   ├── AuthService.java                    # 認証サービス
│   ├── DashboardService.java               # ダッシュボードサービス
│   ├── JobRequirementService.java          # 人員募集要項サービス
│   ├── EmployeeService.java                # SES人員サービス
│   ├── SkillMatchingService.java           # スキルマッチングサービス
│   ├── ReportService.java                  # レポートサービス
│   └── UserService.java                    # ユーザー管理サービス
├── repository/                              # リポジトリ層
│   ├── UserRepository.java                 # ユーザーリポジトリ
│   ├── JobRequirementRepository.java       # 人員募集要項リポジトリ
│   ├── EmployeeRepository.java             # SES人員リポジトリ
│   ├── EmployeeSkillRepository.java        # 人員スキルリポジトリ
│   ├── MatchingResultRepository.java       # マッチング結果リポジトリ
│   ├── SkillMappingRepository.java         # スキルマッピングリポジトリ
│   └── SystemLogRepository.java            # システムログリポジトリ
├── entity/                                  # エンティティ層
│   ├── User.java                           # ユーザーエンティティ
│   ├── UserProfile.java                    # ユーザープロフィールエンティティ
│   ├── JobRequirement.java                 # 人員募集要項エンティティ
│   ├── Employee.java                       # SES人員エンティティ
│   ├── EmployeeSkill.java                  # 人員スキルエンティティ
│   ├── MatchingResult.java                 # マッチング結果エンティティ
│   ├── SkillMapping.java                   # スキルマッピングエンティティ
│   └── SystemLog.java                      # システムログエンティティ
├── dto/                                     # データ転送オブジェクト
│   ├── LoginRequest.java                   # ログインリクエスト
│   ├── JobRequirementDto.java              # 人員募集要項DTO
│   ├── EmployeeDto.java                    # SES人員DTO
│   ├── MatchingRequest.java                # マッチングリクエスト
│   ├── MatchingResultDto.java              # マッチング結果DTO
│   └── DashboardStats.java                 # ダッシュボード統計DTO
├── exception/                               # 例外クラス
│   ├── GlobalExceptionHandler.java         # グローバル例外ハンドラー
│   ├── ResourceNotFoundException.java      # リソース未発見例外
│   ├── ValidationException.java            # バリデーション例外
│   └── AuthenticationException.java        # 認証例外
├── security/                                # セキュリティ関連
│   ├── JwtTokenProvider.java               # JWTトークンプロバイダー
│   ├── CustomUserDetailsService.java       # カスタムユーザー詳細サービス
│   └── JwtAuthenticationFilter.java        # JWT認証フィルター
└── util/                                    # ユーティリティ
    ├── DateUtil.java                       # 日付ユーティリティ
    ├── ValidationUtil.java                 # バリデーションユーティリティ
    └── SecurityUtil.java                   # セキュリティユーティリティ
```

## 3. 依存関係管理

### 3.1 Maven 依存関係 (pom.xml)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.0</version>
        <relativePath/>
    </parent>

    <groupId>com.ses</groupId>
    <artifactId>sales-support-tool</artifactId>
    <version>1.0.0</version>
    <name>SES営業支援ツール</name>
    <description>SES営業支援ツール</description>

    <properties>
        <java.version>17</java.version>
        <thymeleaf.version>3.1.1.RELEASE</thymeleaf.version>
    </properties>

    <dependencies>
        <!-- Spring Boot Starters -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <!-- Database -->
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!-- JWT -->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-api</artifactId>
            <version>0.11.5</version>
        </dependency>
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-impl</artifactId>
            <version>0.11.5</version>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-jackson</artifactId>
            <version>0.11.5</version>
            <scope>runtime</scope>
        </dependency>

        <!-- Development Tools -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>

        <!-- Test Dependencies -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>junit-jupiter</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>postgresql</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

## 4. アプリケーション設定

### 4.1 メインアプリケーションクラス

```java
package com.ses.sales.support;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.data.jpa.repository.config.EnableJpaAuditing;

@SpringBootApplication
@EnableJpaAuditing
public class SesSalesSupportApplication {

    public static void main(String[] args) {
        SpringApplication.run(SesSalesSupportApplication.class, args);
    }
}
```

### 4.2 アプリケーション設定 (application.yml)

```yaml
spring:
  application:
    name: ses-sales-support-tool

  profiles:
    active: dev

  datasource:
    url: ${DATABASE_URL:jdbc:postgresql://localhost:5432/ses_sales_support_db}?sslmode=require
    username: ${DATABASE_USERNAME:postgres}
    password: ${DATABASE_PASSWORD:password}
    driver-class-name: org.postgresql.Driver
    hikari:
      ssl: true
      ssl-mode: require

  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        show_sql: false
    show-sql: false

  thymeleaf:
    cache: false
    prefix: classpath:/templates/
    suffix: .html
    encoding: UTF-8
    mode: HTML

  security:
    jwt:
      secret: ${JWT_SECRET:mySecretKey}
      expiration: 86400000 # 24時間

server:
  port: ${PORT:8080}
  servlet:
    context-path: /
  error:
    include-message: always
    include-binding-errors: always

logging:
  level:
    com.ses.sales.support: DEBUG
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
```

### 4.3 環境別設定

#### 4.3.1 開発環境 (application-dev.yml)

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/ses_sales_support_dev
    username: postgres
    password: dev_password

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true

  thymeleaf:
    cache: false

logging:
  level:
    com.ses.sales.support: DEBUG
    org.springframework.security: DEBUG
```

#### 4.3.2 本番環境 (application-prod.yml)

```yaml
spring:
  datasource:
    url: ${SUPABASE_DATABASE_URL}
    username: ${SUPABASE_DATABASE_USERNAME}
    password: ${SUPABASE_DATABASE_PASSWORD}

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

  thymeleaf:
    cache: true

logging:
  level:
    com.ses.sales.support: INFO
    org.springframework.security: WARN
  file:
    name: /var/log/ses-sales-support/application.log
```

## 5. セキュリティ設定

### 5.1 Spring Security 設定

```java
package com.ses.sales.support.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    private final JwtAuthenticationFilter jwtAuthenticationFilter;

    public SecurityConfig(JwtAuthenticationFilter jwtAuthenticationFilter) {
        this.jwtAuthenticationFilter = jwtAuthenticationFilter;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/login", "/register", "/css/**", "/js/**", "/images/**").permitAll()
                .requestMatchers("/api/v1/admin/**").hasRole("ADMIN")
                .requestMatchers("/api/v1/manager/**").hasAnyRole("ADMIN", "MANAGER")
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

### 5.2 JWT 設定

```java
package com.ses.sales.support.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@Component
@ConfigurationProperties(prefix = "spring.security.jwt")
public class JwtProperties {

    private String secret;
    private long expiration;

    // Getters and Setters
    public String getSecret() {
        return secret;
    }

    public void setSecret(String secret) {
        this.secret = secret;
    }

    public long getExpiration() {
        return expiration;
    }

    public void setExpiration(long expiration) {
        this.expiration = expiration;
    }
}
```

## 6. データベース設定

### 6.1 Supabase 接続設定

```java
package com.ses.sales.support.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
import org.springframework.transaction.PlatformTransactionManager;

import javax.sql.DataSource;
import java.util.Properties;

@Configuration
@EnableJpaRepositories(basePackages = "com.ses.sales.support.repository")
public class DatabaseConfig {

    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(DataSource dataSource) {
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setDataSource(dataSource);
        em.setPackagesToScan("com.ses.sales.support.entity");

        HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();
        em.setJpaVendorAdapter(vendorAdapter);

        Properties properties = new Properties();
        properties.setProperty("hibernate.hbm2ddl.auto", "validate");
        properties.setProperty("hibernate.dialect", "org.hibernate.dialect.PostgreSQLDialect");
        properties.setProperty("hibernate.format_sql", "true");
        em.setJpaProperties(properties);

        return em;
    }

    @Bean
    public PlatformTransactionManager transactionManager(LocalContainerEntityManagerFactoryBean entityManagerFactory) {
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(entityManagerFactory.getObject());
        return transactionManager;
    }
}
```

## 7. Thymeleaf 設定

### 7.1 Thymeleaf 設定クラス

```java
package com.ses.sales.support.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.thymeleaf.spring6.SpringTemplateEngine;
import org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver;
import org.thymeleaf.spring6.view.ThymeleafViewResolver;

@Configuration
public class ThymeleafConfig {

    @Bean
    public SpringResourceTemplateResolver templateResolver() {
        SpringResourceTemplateResolver templateResolver = new SpringResourceTemplateResolver();
        templateResolver.setPrefix("classpath:/templates/");
        templateResolver.setSuffix(".html");
        templateResolver.setTemplateMode("HTML");
        templateResolver.setCharacterEncoding("UTF-8");
        templateResolver.setCacheable(false); // 開発時はfalse
        return templateResolver;
    }

    @Bean
    public SpringTemplateEngine templateEngine(SpringResourceTemplateResolver templateResolver) {
        SpringTemplateEngine templateEngine = new SpringTemplateEngine();
        templateEngine.setTemplateResolver(templateResolver);
        return templateEngine;
    }

    @Bean
    public ThymeleafViewResolver viewResolver(SpringTemplateEngine templateEngine) {
        ThymeleafViewResolver viewResolver = new ThymeleafViewResolver();
        viewResolver.setTemplateEngine(templateEngine);
        viewResolver.setCharacterEncoding("UTF-8");
        return viewResolver;
    }
}
```

## 8. 例外処理設定

### 8.1 グローバル例外ハンドラー

```java
package com.ses.sales.support.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;

import java.util.HashMap;
import java.util.Map;

@ControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<Map<String, String>> handleResourceNotFoundException(ResourceNotFoundException ex) {
        Map<String, String> error = new HashMap<>();
        error.put("error", ex.getMessage());
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
    }

    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<Map<String, String>> handleValidationException(ValidationException ex) {
        Map<String, String> error = new HashMap<>();
        error.put("error", ex.getMessage());
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<Map<String, String>> handleValidationExceptions(MethodArgumentNotValidException ex) {
        Map<String, String> errors = new HashMap<>();
        ex.getBindingResult().getAllErrors().forEach((error) -> {
            String fieldName = ((FieldError) error).getField();
            String errorMessage = error.getDefaultMessage();
            errors.put(fieldName, errorMessage);
        });
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errors);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<Map<String, String>> handleGenericException(Exception ex) {
        Map<String, String> error = new HashMap<>();
        error.put("error", "内部サーバーエラーが発生しました");
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(error);
    }
}
```

## 9. 監視・運用設定

### 9.1 Actuator 設定

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,env,beans
  endpoint:
    health:
      show-details: always
      show-components: always
  info:
    env:
      enabled: true
```

### 9.2 ヘルスチェック設定

```java
package com.ses.sales.support.config;

import org.springframework.boot.actuator.health.Health;
import org.springframework.boot.actuator.health.HealthIndicator;
import org.springframework.stereotype.Component;

import javax.sql.DataSource;
import java.sql.Connection;

@Component
public class DatabaseHealthIndicator implements HealthIndicator {

    private final DataSource dataSource;

    public DatabaseHealthIndicator(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    @Override
    public Health health() {
        try (Connection connection = dataSource.getConnection()) {
            if (connection.isValid(1)) {
                return Health.up()
                    .withDetail("database", "Supabase PostgreSQL")
                    .withDetail("status", "Connected")
                    .build();
            }
        } catch (Exception e) {
            return Health.down()
                .withDetail("database", "Supabase PostgreSQL")
                .withDetail("error", e.getMessage())
                .build();
        }
        return Health.down().build();
    }
}
```

## 10. パフォーマンス設定

### 10.1 接続プール設定

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 30000
```

### 10.2 キャッシュ設定

```java
package com.ses.sales.support.config;

import org.springframework.cache.CacheManager;
import org.springframework.cache.concurrent.ConcurrentMapCacheManager;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class CacheConfig {

    @Bean
    public CacheManager cacheManager() {
        ConcurrentMapCacheManager cacheManager = new ConcurrentMapCacheManager();
        cacheManager.setCacheNames("skillMappings", "skillCategories", "users");
        return cacheManager;
    }
}
```

## 11. 開発・運用の考慮事項

### 11.1 開発時の注意点

- **ホットリロード**: Spring Boot DevTools による自動再起動
- **デバッグ**: IDE でのリモートデバッグ設定
- **プロファイリング**: JProfiler や VisualVM の活用

### 11.2 本番運用の考慮事項

- **ログ管理**: ログローテーション設定
- **監視**: Prometheus + Grafana での監視
- **アラート**: 異常検知時の通知設定
- **バックアップ**: データベースの定期バックアップ

### 11.3 セキュリティ考慮事項

- **HTTPS**: SSL/TLS 証明書の設定
- **ファイアウォール**: 必要最小限のポート開放
- **アクセス制御**: IP 制限の設定
- **監査ログ**: 全操作のログ記録
