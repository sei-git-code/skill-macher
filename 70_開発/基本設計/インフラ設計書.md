# インフラ設計書

## 1. インフラ概要

### 1.1 設計方針
- **クラウドネイティブ**: Oracle Cloud Infrastructure (OCI) を活用
- **マイクロサービス対応**: 将来的なスケーラビリティを考慮
- **セキュリティファースト**: 多層防御によるセキュリティ強化
- **コスト最適化**: 必要最小限のリソースで運用

### 1.2 アーキテクチャ概要
```
┌─────────────────────────────────────────────────────────┐
│                    Internet Gateway                      │
└─────────────────────┬───────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────┐
│                 Load Balancer                           │
│              (OCI Load Balancer)                        │
└─────────────────────┬───────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────┐
│              Application Tier                            │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │   Spring Boot   │  │   Spring Boot   │              │
│  │   Application   │  │   Application   │              │
│  │   (Instance 1)  │  │   (Instance 2)  │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────┐
│                Database Tier                             │
│              Supabase PostgreSQL                         │
│            (Managed Database Service)                    │
└─────────────────────────────────────────────────────────┘
```

## 2. OCI リソース設計

### 2.1 コンパートメント構成
```
Root Compartment
└── SES-Sales-Support-Compartment
    ├── Network Resources
    ├── Compute Resources
    ├── Database Resources
    └── Security Resources
```

### 2.2 VCN (Virtual Cloud Network) 設計
```yaml
VCN Configuration:
  Name: ses-sales-support-vcn
  CIDR Block: 10.0.0.0/16
  
Subnets:
  Public Subnet:
    Name: public-subnet
    CIDR: 10.0.1.0/24
    Purpose: Load Balancer
    
  Private Subnet:
    Name: private-subnet
    CIDR: 10.0.2.0/24
    Purpose: Application Instances
    
  Database Subnet:
    Name: database-subnet
    CIDR: 10.0.3.0/24
    Purpose: Database (if using OCI Database)
```

### 2.3 セキュリティグループ設計
```yaml
Security Lists:
  Load Balancer Security List:
    Inbound Rules:
      - HTTP (80): 0.0.0.0/0
      - HTTPS (443): 0.0.0.0/0
    Outbound Rules:
      - All Traffic: 10.0.2.0/24
      
  Application Security List:
    Inbound Rules:
      - HTTP (8080): 10.0.1.0/24
      - SSH (22): 10.0.1.0/24
    Outbound Rules:
      - HTTPS (443): 0.0.0.0/0 (Supabase)
      - HTTP (80): 0.0.0.0/0 (Package Updates)
      
  Database Security List:
    Inbound Rules:
      - PostgreSQL (5432): 10.0.2.0/24
    Outbound Rules:
      - None
```

## 3. コンピュート設計

### 3.1 インスタンス仕様
```yaml
Application Instances:
  Shape: VM.Standard.E2.1.Micro (Always Free)
  vCPU: 1
  Memory: 1 GB
  Storage: 50 GB (Boot Volume)
  
  Alternative (Paid):
  Shape: VM.Standard.E2.1
  vCPU: 1
  Memory: 8 GB
  Storage: 100 GB (Boot Volume)
```

### 3.2 インスタンス構成
```yaml
Instance Configuration:
  Name: ses-sales-support-app
  Count: 2 (High Availability)
  Availability Domain: AD-1, AD-2
  Fault Domain: FD-1, FD-2
  
Operating System:
  Image: Oracle Linux 8
  Version: Latest
  
Software Stack:
  Java: OpenJDK 17
  Spring Boot: 3.2.0
  Nginx: Latest (Reverse Proxy)
```

### 3.3 自動スケーリング設定
```yaml
Auto Scaling Configuration:
  Metric: CPU Utilization
  Scale Out Threshold: 70%
  Scale In Threshold: 30%
  Min Instances: 1
  Max Instances: 5
  Cooldown Period: 300 seconds
```

## 4. ロードバランサー設計

### 4.1 OCI Load Balancer 設定
```yaml
Load Balancer Configuration:
  Name: ses-sales-support-lb
  Shape: Flexible
  Minimum Bandwidth: 10 Mbps
  Maximum Bandwidth: 100 Mbps
  
Backend Servers:
  - Instance 1: 10.0.2.10:8080
  - Instance 2: 10.0.2.11:8080
  
Health Check:
  Protocol: HTTP
  Port: 8080
  Path: /actuator/health
  Interval: 30 seconds
  Timeout: 5 seconds
  Retries: 3
  
SSL Configuration:
  Certificate: Let's Encrypt (Free)
  Cipher Suite: Modern
  TLS Version: 1.2, 1.3
```

### 4.2 ドメイン・DNS 設定
```yaml
Domain Configuration:
  Domain: ses-sales-support.example.com
  DNS Provider: Oracle Cloud DNS
  
SSL Certificate:
  Type: Let's Encrypt
  Auto Renewal: Enabled
  Validation: DNS Challenge
```

## 5. Supabase PostgreSQL 設計

### 5.1 Supabase プロジェクト設定
```yaml
Supabase Configuration:
  Project Name: ses-sales-support-db
  Region: Asia Pacific (Tokyo)
  Plan: Pro Plan
  
Database Settings:
  PostgreSQL Version: 15
  Connection Pooling: Enabled
  SSL: Required
  
Backup Settings:
  Automated Backups: Daily
  Retention Period: 30 days
  Point-in-Time Recovery: Enabled
```

### 5.2 接続設定
```yaml
Connection Configuration:
  Host: db.xxxxxxxxxxxx.supabase.co
  Port: 5432
  Database: postgres
  Username: postgres
  Password: [Secure Password]
  SSL Mode: require
  
Connection Pool:
  Min Connections: 5
  Max Connections: 20
  Connection Timeout: 30 seconds
  Idle Timeout: 300 seconds
```

### 5.3 Row Level Security (RLS) 設定
```sql
-- ユーザーテーブルのRLS設定
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ユーザーは自分のデータのみアクセス可能
CREATE POLICY user_policy ON users
    FOR ALL TO authenticated
    USING (auth.uid()::text = id);

-- 管理者は全データにアクセス可能
CREATE POLICY admin_policy ON users
    FOR ALL TO authenticated
    USING (
        EXISTS (
            SELECT 1 FROM users 
            WHERE id = auth.uid()::text 
            AND role = 'ADMIN'
        )
    );
```

## 6. ストレージ設計

### 6.1 Object Storage 設定
```yaml
Object Storage Configuration:
  Name: ses-sales-support-storage
  Storage Class: Standard
  Encryption: Server-Side Encryption
  
Buckets:
  - ses-sales-support-logs
  - ses-sales-support-backups
  - ses-sales-support-uploads
  
Access Control:
  Public Access: Disabled
  Pre-Authenticated Requests: Enabled
  Lifecycle Policy: 90 days
```

### 6.2 バックアップ設計
```yaml
Backup Strategy:
  Database Backup:
    Frequency: Daily
    Retention: 30 days
    Location: Object Storage
    
  Application Backup:
    Frequency: Weekly
    Retention: 12 weeks
    Location: Object Storage
    
  Configuration Backup:
    Frequency: Daily
    Retention: 90 days
    Location: Object Storage
```

## 7. 監視・ログ設計

### 7.1 OCI Monitoring 設定
```yaml
Monitoring Configuration:
  Metrics:
    - CPU Utilization
    - Memory Utilization
    - Disk Usage
    - Network I/O
    - Application Response Time
    
  Alarms:
    - High CPU Usage (>80%)
    - High Memory Usage (>85%)
    - Disk Space Low (<20%)
    - Application Down
    
  Notification:
    - Email: admin@example.com
    - Slack: #infrastructure-alerts
```

### 7.2 ログ管理
```yaml
Log Configuration:
  Application Logs:
    Location: /var/log/ses-sales-support/
    Format: JSON
    Rotation: Daily
    Retention: 30 days
    
  System Logs:
    Location: /var/log/messages
    Rotation: Weekly
    Retention: 12 weeks
    
  Access Logs:
    Location: /var/log/nginx/
    Format: Combined
    Rotation: Daily
    Retention: 90 days
```

## 8. セキュリティ設計

### 8.1 ネットワークセキュリティ
```yaml
Network Security:
  VCN Security:
    - Private Subnets for Applications
    - Public Subnets for Load Balancers
    - Security Lists with Minimal Access
    
  Firewall Rules:
    - Inbound: HTTP/HTTPS only
    - Outbound: Supabase and Package Updates only
    
  VPN Access:
    - Site-to-Site VPN for Admin Access
    - Client VPN for Remote Access
```

### 8.2 アプリケーションセキュリティ
```yaml
Application Security:
  SSL/TLS:
    - TLS 1.2+ Required
    - HSTS Enabled
    - Perfect Forward Secrecy
    
  Authentication:
    - JWT Tokens
    - Session Timeout: 30 minutes
    - Password Policy: Strong
    
  Authorization:
    - Role-Based Access Control
    - API Rate Limiting
    - CORS Configuration
```

### 8.3 データセキュリティ
```yaml
Data Security:
  Encryption:
    - At Rest: AES-256
    - In Transit: TLS 1.3
    - Database: Supabase Encryption
    
  Access Control:
    - Row Level Security (RLS)
    - API Key Management
    - Audit Logging
    
  Compliance:
    - GDPR Compliance
    - Data Retention Policy
    - Privacy by Design
```

## 9. 災害復旧設計

### 9.1 バックアップ戦略
```yaml
Backup Strategy:
  Database:
    - Daily Automated Backups
    - Point-in-Time Recovery
    - Cross-Region Replication
    
  Application:
    - Configuration Backup
    - Code Repository Backup
    - Environment Backup
    
  Recovery Time Objective (RTO): 4 hours
  Recovery Point Objective (RPO): 1 hour
```

### 9.2 高可用性設計
```yaml
High Availability:
  Application Tier:
    - Multi-AZ Deployment
    - Auto Scaling
    - Health Checks
    
  Database Tier:
    - Supabase High Availability
    - Read Replicas
    - Connection Pooling
    
  Load Balancer:
    - Health Checks
    - Failover
    - SSL Termination
```

## 10. コスト最適化

### 10.1 Always Free リソース活用
```yaml
Always Free Resources:
  Compute:
    - 2 VM.Standard.E2.1.Micro instances
    - 1 GB RAM, 1 vCPU each
    
  Storage:
    - 200 GB Block Storage
    - 20 GB Object Storage
    
  Network:
    - 10 TB Data Transfer
    - Load Balancer (10 Mbps)
```

### 10.2 コスト管理
```yaml
Cost Management:
  Budget Alerts:
    - Monthly Budget: $100
    - Alert Threshold: 80%
    
  Resource Optimization:
    - Right-sizing Instances
    - Reserved Instances
    - Spot Instances (if applicable)
    
  Monitoring:
    - Cost Analysis Dashboard
    - Resource Utilization Reports
    - Automated Scaling
```

## 11. 環境別設定

### 11.1 開発環境
```yaml
Development Environment:
  Instances: 1 (VM.Standard.E2.1.Micro)
  Database: Supabase Free Tier
  Domain: dev.ses-sales-support.example.com
  SSL: Self-signed Certificate
  Monitoring: Basic
```

### 11.2 ステージング環境
```yaml
Staging Environment:
  Instances: 1 (VM.Standard.E2.1)
  Database: Supabase Pro Tier
  Domain: staging.ses-sales-support.example.com
  SSL: Let's Encrypt
  Monitoring: Standard
```

### 11.3 本番環境
```yaml
Production Environment:
  Instances: 2+ (VM.Standard.E2.1)
  Database: Supabase Pro Tier
  Domain: ses-sales-support.example.com
  SSL: Let's Encrypt
  Monitoring: Full
  Backup: Automated
  High Availability: Enabled
```

## 12. デプロイメント設計

### 12.1 CI/CD パイプライン
```yaml
CI/CD Pipeline:
  Source: GitHub
  Build: GitHub Actions
  Test: JUnit, Integration Tests
  Deploy: OCI CLI
  
  Stages:
    1. Code Checkout
    2. Build Application
    3. Run Tests
    4. Build Docker Image
    5. Deploy to OCI
    6. Health Check
    7. Rollback (if needed)
```

### 12.2 デプロイメント戦略
```yaml
Deployment Strategy:
  Blue-Green Deployment:
    - Zero Downtime
    - Instant Rollback
    - Traffic Switching
    
  Rolling Deployment:
    - Gradual Rollout
    - Health Checks
    - Automatic Rollback
```

## 13. 運用設計

### 13.1 監視ダッシュボード
```yaml
Monitoring Dashboard:
  Infrastructure Metrics:
    - CPU, Memory, Disk Usage
    - Network I/O
    - Response Time
    
  Application Metrics:
    - Request Rate
    - Error Rate
    - Response Time
    - User Activity
    
  Business Metrics:
    - User Registrations
    - Job Requirements Created
    - Matching Results Generated
```

### 13.2 アラート設定
```yaml
Alert Configuration:
  Critical Alerts:
    - Application Down
    - Database Connection Failed
    - High Error Rate (>5%)
    
  Warning Alerts:
    - High CPU Usage (>80%)
    - High Memory Usage (>85%)
    - Slow Response Time (>2s)
    
  Notification Channels:
    - Email
    - Slack
    - SMS (Critical only)
```

## 14. セキュリティ監査

### 14.1 セキュリティチェックリスト
```yaml
Security Checklist:
  Network Security:
    - [ ] VCN Security Lists Configured
    - [ ] Private Subnets Used
    - [ ] Firewall Rules Minimal
    
  Application Security:
    - [ ] HTTPS Enabled
    - [ ] Authentication Implemented
    - [ ] Authorization Configured
    - [ ] Input Validation
    - [ ] SQL Injection Prevention
    
  Data Security:
    - [ ] Encryption at Rest
    - [ ] Encryption in Transit
    - [ ] Access Control
    - [ ] Audit Logging
```

### 14.2 脆弱性管理
```yaml
Vulnerability Management:
  Scanning:
    - Weekly Security Scans
    - Dependency Vulnerability Checks
    - Container Image Scans
    
  Patching:
    - Monthly Security Updates
    - Critical Patches (Immediate)
    - Regular Dependency Updates
    
  Compliance:
    - Security Standards Compliance
    - Regular Security Audits
    - Penetration Testing
```
