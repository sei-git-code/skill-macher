# データベース設計書

## 1. データベース概要

### 1.1 データベース名

ses_sales_support_db

### 1.2 データベース種別

PostgreSQL (Supabase)

### 1.3 設計方針

- **正規化**: 第 3 正規形まで適用
- **パフォーマンス**: インデックス最適化
- **セキュリティ**: アプリケーションレベルでの認可制御（RLS 制限のため）
- **拡張性**: 将来の機能拡張に対応
- **Spring Data JPA**: JPA エンティティとの整合性

**⚠️ 重要: Row Level Security (RLS) の制限について**

Supabase RLS は Supabase クライアント（JavaScript/TypeScript）でのみ動作し、Spring Boot から直接 PostgreSQL に接続する場合には機能しません。そのため、以下の方式を採用します：

- **アプリケーションレベルでの認可制御**
  - Spring Security による認証・認可
  - サービス層でのデータアクセス制御
  - ユーザー ID に基づくデータフィルタリング

## 2. テーブル設計

### 2.1 ユーザー管理テーブル

#### users (ユーザー情報)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user', -- 'admin', 'manager', 'user'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_active BOOLEAN DEFAULT TRUE
);
```

#### user_profiles (ユーザープロフィール)

```sql
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    company_name VARCHAR(200),
    department VARCHAR(100),
    phone VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.2 人員募集要項テーブル

#### job_requirements (人員募集要項)

```sql
CREATE TABLE job_requirements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_name VARCHAR(200) NOT NULL,
    client_name VARCHAR(200),
    description TEXT,
    required_skills JSONB NOT NULL, -- 必須スキル配列
    preferred_skills JSONB, -- 希望スキル配列
    experience_years INTEGER NOT NULL,
    budget_range VARCHAR(50),
    start_date DATE,
    end_date DATE,
    location VARCHAR(100),
    work_style VARCHAR(50), -- 'remote', 'onsite', 'hybrid'
    additional_requirements TEXT,
    status VARCHAR(20) DEFAULT 'active', -- 'active', 'closed', 'cancelled'
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3 SES 人員管理テーブル

#### employees (SES 人員情報)

```sql
CREATE TABLE employees (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255),
    phone VARCHAR(20),
    birth_date DATE,
    gender VARCHAR(10),
    address TEXT,
    education VARCHAR(200),
    certification JSONB, -- 資格情報
    availability VARCHAR(20) DEFAULT 'available', -- 'available', 'busy', 'unavailable'
    hourly_rate INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### employee_skills (人員スキル情報)

```sql
CREATE TABLE employee_skills (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID REFERENCES employees(id) ON DELETE CASCADE,
    technology VARCHAR(100) NOT NULL,
    proficiency VARCHAR(20) NOT NULL, -- 'beginner', 'intermediate', 'advanced', 'expert'
    experience_years DECIMAL(3,1) NOT NULL,
    last_used_date DATE,
    project_experience JSONB, -- プロジェクト経験
    certification JSONB, -- 技術認定
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(employee_id, technology)
);
```

### 2.4 スキルマッチングテーブル

#### skill_mappings (スキル関連性マッピング)

```sql
CREATE TABLE skill_mappings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    from_technology VARCHAR(100) NOT NULL,
    to_technology VARCHAR(100) NOT NULL,
    compatibility_score DECIMAL(5,2) NOT NULL, -- 0.00-100.00
    learning_cost VARCHAR(20) NOT NULL, -- 'low', 'medium', 'high'
    learning_duration VARCHAR(50), -- '1-2 weeks', '1-2 months', '3-6 months'
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(from_technology, to_technology)
);
```

#### matching_results (マッチング結果)

```sql
CREATE TABLE matching_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_requirement_id UUID REFERENCES job_requirements(id) ON DELETE CASCADE,
    employee_id UUID REFERENCES employees(id) ON DELETE CASCADE,
    overall_score DECIMAL(5,2) NOT NULL, -- 0.00-100.00
    skill_match_score DECIMAL(5,2) NOT NULL,
    experience_match_score DECIMAL(5,2) NOT NULL,
    proficiency_match_score DECIMAL(5,2) NOT NULL,
    matched_skills JSONB NOT NULL,
    missing_skills JSONB NOT NULL,
    recommendation_level VARCHAR(20) NOT NULL, -- 'high', 'medium', 'low'
    recommendation_comment TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(job_requirement_id, employee_id)
);
```

### 2.5 システム管理テーブル

#### system_logs (システムログ)

```sql
CREATE TABLE system_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    action VARCHAR(100) NOT NULL,
    table_name VARCHAR(100),
    record_id UUID,
    old_values JSONB,
    new_values JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### skill_categories (スキルカテゴリ)

```sql
CREATE TABLE skill_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    parent_id UUID REFERENCES skill_categories(id),
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 3. インデックス設計

### 3.1 主要インデックス

```sql
-- ユーザー関連
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_active ON users(is_active);

-- 人員募集要項関連
CREATE INDEX idx_job_requirements_status ON job_requirements(status);
CREATE INDEX idx_job_requirements_created_by ON job_requirements(created_by);
CREATE INDEX idx_job_requirements_created_at ON job_requirements(created_at);

-- SES人員関連
CREATE INDEX idx_employees_employee_id ON employees(employee_id);
CREATE INDEX idx_employees_availability ON employees(availability);
CREATE INDEX idx_employee_skills_technology ON employee_skills(technology);
CREATE INDEX idx_employee_skills_proficiency ON employee_skills(proficiency);

-- マッチング結果関連
CREATE INDEX idx_matching_results_job_id ON matching_results(job_requirement_id);
CREATE INDEX idx_matching_results_employee_id ON matching_results(employee_id);
CREATE INDEX idx_matching_results_score ON matching_results(overall_score DESC);

-- スキルマッピング関連
CREATE INDEX idx_skill_mappings_from_tech ON skill_mappings(from_technology);
CREATE INDEX idx_skill_mappings_to_tech ON skill_mappings(to_technology);
```

## 4. 制約・ルール

### 4.1 データ制約

```sql
-- ユーザー関連制約
ALTER TABLE users ADD CONSTRAINT chk_user_role
    CHECK (role IN ('admin', 'manager', 'user'));

-- 人員募集要項制約
ALTER TABLE job_requirements ADD CONSTRAINT chk_experience_years
    CHECK (experience_years >= 0 AND experience_years <= 50);

ALTER TABLE job_requirements ADD CONSTRAINT chk_job_status
    CHECK (status IN ('active', 'closed', 'cancelled'));

-- SES人員制約
ALTER TABLE employees ADD CONSTRAINT chk_availability
    CHECK (availability IN ('available', 'busy', 'unavailable'));

ALTER TABLE employees ADD CONSTRAINT chk_hourly_rate
    CHECK (hourly_rate >= 0);

-- スキル制約
ALTER TABLE employee_skills ADD CONSTRAINT chk_proficiency
    CHECK (proficiency IN ('beginner', 'intermediate', 'advanced', 'expert'));

ALTER TABLE employee_skills ADD CONSTRAINT chk_experience_years_skill
    CHECK (experience_years >= 0 AND experience_years <= 50);

-- マッチング結果制約
ALTER TABLE matching_results ADD CONSTRAINT chk_overall_score
    CHECK (overall_score >= 0 AND overall_score <= 100);

ALTER TABLE matching_results ADD CONSTRAINT chk_recommendation_level
    CHECK (recommendation_level IN ('high', 'medium', 'low'));
```

### 4.2 外部キー制約

```sql
-- 既に定義済みの外部キー制約
-- users -> user_profiles
-- users -> job_requirements (created_by)
-- employees -> employee_skills
-- job_requirements -> matching_results
-- employees -> matching_results
-- users -> system_logs
```

## 5. Row Level Security (RLS)

### 5.1 RLS ポリシー

```sql
-- ユーザーテーブルのRLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own data" ON users
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update their own data" ON users
    FOR UPDATE USING (auth.uid() = id);

-- 人員募集要項のRLS
ALTER TABLE job_requirements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view all job requirements" ON job_requirements
    FOR SELECT USING (true);

CREATE POLICY "Users can create job requirements" ON job_requirements
    FOR INSERT WITH CHECK (auth.uid() = created_by);

CREATE POLICY "Users can update their own job requirements" ON job_requirements
    FOR UPDATE USING (auth.uid() = created_by);

-- SES人員のRLS
ALTER TABLE employees ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view all employees" ON employees
    FOR SELECT USING (true);

CREATE POLICY "Managers can manage employees" ON employees
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role IN ('admin', 'manager')
        )
    );
```

## 6. 初期データ

### 6.1 スキルマッピング初期データ

```sql
INSERT INTO skill_mappings (from_technology, to_technology, compatibility_score, learning_cost, learning_duration, description) VALUES
('jQuery', 'React', 75.00, 'medium', '1-2 months', 'JavaScript基礎知識共通、パラダイム違いで学習コスト発生'),
('jQuery', 'Vue.js', 70.00, 'medium', '1-2 months', '同様の移行パターン'),
('HTML/CSS', 'React', 65.00, 'medium', '1-2 months', 'マークアップ経験活用可能'),
('HTML/CSS', 'Vue.js', 60.00, 'medium', '1-2 months', 'マークアップ経験活用可能'),
('Java', 'Spring Boot', 90.00, 'low', '1-2 weeks', '同一言語、フレームワーク移行'),
('Java', 'Spring Framework', 85.00, 'low', '1-2 weeks', '同一言語、フレームワーク移行'),
('C#', '.NET Core', 88.00, 'low', '1-2 weeks', '同一言語、フレームワーク移行'),
('PHP', 'Laravel', 80.00, 'low', '1-2 weeks', '同一言語、フレームワーク移行'),
('MySQL', 'PostgreSQL', 85.00, 'low', '1-2 weeks', 'SQL知識共通'),
('Oracle', 'MySQL', 80.00, 'low', '1-2 weeks', 'SQL知識共通'),
('SQL Server', 'PostgreSQL', 75.00, 'low', '1-2 weeks', 'SQL知識共通'),
('AWS', 'Azure', 70.00, 'medium', '1-2 months', 'クラウド概念共通'),
('Docker', 'Kubernetes', 75.00, 'medium', '1-2 months', 'コンテナ技術関連'),
('Linux', 'Windows Server', 60.00, 'high', '3-6 months', 'OS管理経験');
```

### 6.2 スキルカテゴリ初期データ

```sql
INSERT INTO skill_categories (name, description, sort_order) VALUES
('フロントエンド', 'フロントエンド開発技術', 1),
('バックエンド', 'バックエンド開発技術', 2),
('データベース', 'データベース技術', 3),
('クラウド・インフラ', 'クラウド・インフラストラクチャ技術', 4),
('モバイル', 'モバイルアプリ開発技術', 5),
('AI・機械学習', 'AI・機械学習技術', 6);
```

## 7. バックアップ・復旧

### 7.1 バックアップ戦略

- **自動バックアップ**: Supabase 自動バックアップ（日次）
- **手動バックアップ**: 重要更新前の手動バックアップ
- **データ保持期間**: 30 日間

### 7.2 復旧手順

1. Supabase 管理画面からバックアップ選択
2. 復旧対象の日時指定
3. 復旧実行
4. データ整合性確認
5. アプリケーション動作確認
