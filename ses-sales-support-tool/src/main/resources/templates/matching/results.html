<!DOCTYPE html>
<html
  lang="ja"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout :: layout(~{::title}, ~{::content})}"
>
  <head>
    <title>マッチング結果 - [[${jobRequirement.projectName}]]</title>
  </head>
  <body>
    <div th:fragment="content">
      <div class="container-fluid">
        <!-- ヘッダー -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h2 class="mb-1">マッチング結果</h2>
                <p class="text-muted mb-0">
                  [[${jobRequirement.projectName}]] -
                  [[${jobRequirement.clientName}]]
                </p>
              </div>
              <div>
                <a
                  th:href="@{/job-requirements/{id}(id=${jobRequirement.id})}"
                  class="btn btn-outline-secondary me-2"
                >
                  <i class="fas fa-arrow-left"></i> 案件詳細に戻る
                </a>
                <button
                  type="button"
                  class="btn btn-primary"
                  onclick="executeMatching()"
                >
                  <i class="fas fa-sync"></i> マッチング再実行
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 案件情報 -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title mb-0">案件情報</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <p>
                      <strong>プロジェクト名:</strong>
                      [[${jobRequirement.projectName}]]
                    </p>
                    <p>
                      <strong>クライアント:</strong>
                      [[${jobRequirement.clientName}]]
                    </p>
                    <p>
                      <strong>勤務形態:</strong> [[${jobRequirement.workType}]]
                    </p>
                    <p>
                      <strong>優先度:</strong>
                      <span
                        class="badge"
                        th:classappend="${jobRequirement.priority == 'HIGH'} ? 'bg-danger' : 
                                                                        ${jobRequirement.priority == 'MEDIUM'} ? 'bg-warning' : 'bg-info'"
                      >
                        [[${jobRequirement.priority}]]
                      </span>
                    </p>
                  </div>
                  <div class="col-md-6">
                    <p>
                      <strong>経験年数:</strong>
                      [[${jobRequirement.experienceYears}]]年以上
                    </p>
                    <p>
                      <strong>予算:</strong>
                      <span th:if="${jobRequirement.budget != null}">
                        ¥[[${#numbers.formatDecimal(jobRequirement.budget, 0,
                        'COMMA', 0, 'POINT')}]]
                      </span>
                      <span
                        th:unless="${jobRequirement.budget != null}"
                        class="text-muted"
                        >未設定</span
                      >
                    </p>
                    <p>
                      <strong>ステータス:</strong>
                      <span
                        class="badge"
                        th:classappend="${jobRequirement.status == 'OPEN'} ? 'bg-success' : 
                                                                        ${jobRequirement.status == 'CLOSED'} ? 'bg-secondary' : 'bg-warning'"
                      >
                        [[${jobRequirement.status}]]
                      </span>
                    </p>
                  </div>
                </div>
                <div
                  class="row mt-3"
                  th:if="${jobRequirement.requiredSkills != null and !#strings.isEmpty(jobRequirement.requiredSkills)}"
                >
                  <div class="col-12">
                    <p><strong>必須スキル:</strong></p>
                    <div class="d-flex flex-wrap gap-2">
                      <span
                        th:each="skill : ${#strings.arraySplit(jobRequirement.requiredSkills, ',')}"
                        class="badge bg-primary"
                        >[[${#strings.trim(skill)}]]</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- マッチング結果 -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <h5 class="card-title mb-0">マッチング結果</h5>
                <span class="badge bg-primary"
                  >[[${#lists.size(matchingResults)}]]件</span
                >
              </div>
              <div class="card-body">
                <div
                  th:if="${#lists.isEmpty(matchingResults)}"
                  class="text-center py-5"
                >
                  <i class="fas fa-search fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">マッチング結果がありません</h5>
                  <p class="text-muted">
                    マッチングを実行して結果を確認してください。
                  </p>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="executeMatching()"
                  >
                    <i class="fas fa-play"></i> マッチング実行
                  </button>
                </div>

                <div
                  th:unless="${#lists.isEmpty(matchingResults)}"
                  class="table-responsive"
                >
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>従業員名</th>
                        <th>マッチングスコア</th>
                        <th>スキルスコア</th>
                        <th>経験スコア</th>
                        <th>予算スコア</th>
                        <th>ステータス</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="result : ${matchingResults}">
                        <td>
                          <div>
                            <strong>[[${result.employee.name}]]</strong>
                            <br />
                            <small class="text-muted"
                              >[[${result.employee.email}]]</small
                            >
                          </div>
                        </td>
                        <td>
                          <div class="d-flex align-items-center">
                            <div
                              class="progress me-2"
                              style="width: 100px; height: 20px"
                            >
                              <div
                                class="progress-bar"
                                th:style="'width: ' + ${result.matchScore} + '%'"
                                th:classappend="${result.matchScore >= 80} ? 'bg-success' : 
                                                                           ${result.matchScore >= 60} ? 'bg-warning' : 'bg-danger'"
                              ></div>
                            </div>
                            <span class="fw-bold"
                              >[[${#numbers.formatDecimal(result.matchScore, 1,
                              1)}]]%</span
                            >
                          </div>
                        </td>
                        <td>
                          <span class="badge bg-info"
                            >[[${#numbers.formatDecimal(result.skillMatchScore,
                            1, 1)}]]%</span
                          >
                        </td>
                        <td>
                          <span class="badge bg-success"
                            >[[${#numbers.formatDecimal(result.experienceMatchScore,
                            1, 1)}]]%</span
                          >
                        </td>
                        <td>
                          <span class="badge bg-warning"
                            >[[${#numbers.formatDecimal(result.budgetMatchScore,
                            1, 1)}]]%</span
                          >
                        </td>
                        <td>
                          <span
                            class="badge"
                            th:classappend="${result.status == 'APPROVED'} ? 'bg-success' : 
                                                                              ${result.status == 'REJECTED'} ? 'bg-danger' : 'bg-secondary'"
                          >
                            [[${result.status}]]
                          </span>
                        </td>
                        <td>
                          <div class="btn-group" role="group">
                            <a
                              th:href="@{/matching/result/{id}(id=${result.id})}"
                              class="btn btn-sm btn-outline-primary"
                            >
                              <i class="fas fa-eye"></i> 詳細
                            </a>
                            <button
                              type="button"
                              class="btn btn-sm btn-success"
                              th:onclick="'approveResult(' + ${result.id} + ')'"
                            >
                              <i class="fas fa-check"></i> 承認
                            </button>
                            <button
                              type="button"
                              class="btn btn-sm btn-danger"
                              th:onclick="'rejectResult(' + ${result.id} + ')'"
                            >
                              <i class="fas fa-times"></i> 却下
                            </button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ローディングオーバーレイ -->
      <div id="loadingOverlay" class="loading-overlay" style="display: none">
        <div class="loading-spinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">マッチングを実行中...</p>
        </div>
      </div>
    </div>

    <script>
      function executeMatching() {
          const loadingOverlay = document.getElementById('loadingOverlay');
          loadingOverlay.style.display = 'flex';

          fetch(`/matching/api/execute/${[[${jobRequirement.id}]]}`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              }
          })
          .then(response => {
              if (response.ok) {
                  location.reload();
              } else {
                  throw new Error('マッチングの実行に失敗しました');
              }
          })
          .catch(error => {
              console.error('Error:', error);
              alert('マッチングの実行に失敗しました: ' + error.message);
              loadingOverlay.style.display = 'none';
          });
      }

      function approveResult(resultId) {
          if (confirm('このマッチング結果を承認しますか？')) {
              const form = document.createElement('form');
              form.method = 'POST';
              form.action = `/matching/result/${resultId}/approve`;

              const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
              const csrfInput = document.createElement('input');
              csrfInput.type = 'hidden';
              csrfInput.name = '_csrf';
              csrfInput.value = csrfToken;
              form.appendChild(csrfInput);

              document.body.appendChild(form);
              form.submit();
          }
      }

      function rejectResult(resultId) {
          const reason = prompt('却下理由を入力してください（任意）:');
          if (reason !== null) {
              const form = document.createElement('form');
              form.method = 'POST';
              form.action = `/matching/result/${resultId}/reject`;

              const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
              const csrfInput = document.createElement('input');
              csrfInput.type = 'hidden';
              csrfInput.name = '_csrf';
              csrfInput.value = csrfToken;
              form.appendChild(csrfInput);

              if (reason) {
                  const reasonInput = document.createElement('input');
                  reasonInput.type = 'hidden';
                  reasonInput.name = 'reason';
                  reasonInput.value = reason;
                  form.appendChild(reasonInput);
              }

              document.body.appendChild(form);
              form.submit();
          }
      }
    </script>
  </body>
</html>

